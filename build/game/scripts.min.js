!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define,1){var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.CANNON=t()}else define([],t)}(function(){return function t(e,i,o){function s(r,a){if(!i[r]){if(!e[r]){var h="function"==typeof require&&require;if(!a&&h)return h(r,!0);if(n)return n(r,!0);throw new Error("Cannot find module '"+r+"'")}var l=i[r]={exports:{}};e[r][0].call(l.exports,function(t){var i=e[r][1][t];return s(i?i:t)},l,l.exports,t,e,i,o)}return i[r].exports}for(var n="function"==typeof require&&require,r=0;r<o.length;r++)s(o[r]);return s}({1:[function(t,e){e.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,e){function i(t){t=t||{},this.lowerBound=new o,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new o,t.upperBound&&this.upperBound.copy(t.upperBound)}var o=t("../math/Vec3");t("../utils/Utils"),e.exports=i;var s=new o;i.prototype.setFromPoints=function(t,e,i,o){var n=this.lowerBound,r=this.upperBound,a=i;n.copy(t[0]),a&&a.vmult(n,n),r.copy(n);for(var h=1;h<t.length;h++){var l=t[h];a&&(a.vmult(l,s),l=s),l.x>r.x&&(r.x=l.x),l.x<n.x&&(n.x=l.x),l.y>r.y&&(r.y=l.y),l.y<n.y&&(n.y=l.y),l.z>r.z&&(r.z=l.z),l.z<n.z&&(n.z=l.z)}return e&&(e.vadd(n,n),e.vadd(r,r)),o&&(n.x-=o,n.y-=o,n.z-=o,r.x+=o,r.y+=o,r.z+=o),this},i.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(t){var e=t.lowerBound.x;this.lowerBound.x>e&&(this.lowerBound.x=e);var i=t.upperBound.x;this.upperBound.x<i&&(this.upperBound.x=i);var e=t.lowerBound.y;this.lowerBound.y>e&&(this.lowerBound.y=e);var i=t.upperBound.y;this.upperBound.y<i&&(this.upperBound.y=i);var e=t.lowerBound.z;this.lowerBound.z>e&&(this.lowerBound.z=e);var i=t.upperBound.z;this.upperBound.z<i&&(this.upperBound.z=i)},i.prototype.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,s=t.upperBound;return(o.x<=i.x&&i.x<=s.x||e.x<=s.x&&s.x<=i.x)&&(o.y<=i.y&&i.y<=s.y||e.y<=s.y&&s.y<=i.y)&&(o.z<=i.z&&i.z<=s.z||e.z<=s.z&&s.z<=i.z)},i.prototype.contains=function(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,s=t.upperBound;return e.x<=o.x&&i.x>=s.x&&e.y<=o.y&&i.y>=s.y&&e.z<=o.z&&i.z>=s.z},i.prototype.getCorners=function(t,e,i,o,s,n,r,a){var h=this.lowerBound,l=this.upperBound;t.copy(h),e.set(l.x,h.y,h.z),i.set(l.x,l.y,h.z),o.set(h.x,l.y,l.z),s.set(l.x,h.y,h.z),n.set(h.x,l.y,h.z),r.set(h.x,h.y,l.z),a.copy(l)};var n=[new o,new o,new o,new o,new o,new o,new o,new o];i.prototype.toLocalFrame=function(t,e){var i=n,o=i[0],s=i[1],r=i[2],a=i[3],h=i[4],l=i[5],p=i[6],c=i[7];this.getCorners(o,s,r,a,h,l,p,c);for(var u=0;8!==u;u++){var d=i[u];t.pointToLocal(d,d)}return e.setFromPoints(i)},i.prototype.toWorldFrame=function(t,e){var i=n,o=i[0],s=i[1],r=i[2],a=i[3],h=i[4],l=i[5],p=i[6],c=i[7];this.getCorners(o,s,r,a,h,l,p,c);for(var u=0;8!==u;u++){var d=i[u];t.pointToWorld(d,d)}return e.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,e){function i(){this.matrix=[]}e.exports=i,i.prototype.get=function(t,e){if(t=t.index,e=e.index,e>t){var i=e;e=t,t=i}return this.matrix[(t*(t+1)>>1)+e-1]},i.prototype.set=function(t,e,i){if(t=t.index,e=e.index,e>t){var o=e;e=t,t=o}this.matrix[(t*(t+1)>>1)+e-1]=i?1:0},i.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},i.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e){function i(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var o=t("../objects/Body"),s=t("../math/Vec3"),n=t("../math/Quaternion");t("../shapes/Shape"),t("../shapes/Plane"),e.exports=i,i.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var r=o.STATIC|o.KINEMATIC;i.prototype.needBroadphaseCollision=function(t,e){return 0!==(t.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&t.collisionFilterMask)&&(0===(t.type&r)&&t.sleepState!==o.SLEEPING||0===(e.type&r)&&e.sleepState!==o.SLEEPING)},i.prototype.intersectionTest=function(t,e,i,o){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,o):this.doBoundingSphereBroadphase(t,e,i,o)};var a=new s;new s,new n,new s,i.prototype.doBoundingSphereBroadphase=function(t,e,i,o){var s=a;e.position.vsub(t.position,s);var n=Math.pow(t.boundingRadius+e.boundingRadius,2),r=s.norm2();n>r&&(i.push(t),o.push(e))},i.prototype.doBoundingBoxBroadphase=function(t,e,i,o){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),o.push(e))};var h={keys:[]},l=[],p=[];i.prototype.makePairsUnique=function(t,e){for(var i=h,o=l,s=p,n=t.length,r=0;r!==n;r++)o[r]=t[r],s[r]=e[r];t.length=0,e.length=0;for(var r=0;r!==n;r++){var a=o[r].id,c=s[r].id,u=c>a?a+","+c:c+","+a;i[u]=r,i.keys.push(u)}for(var r=0;r!==i.keys.length;r++){var u=i.keys.pop(),d=i[u];t.push(o[d]),e.push(s[d]),delete i[u]}},i.prototype.setWorld=function(){};var c=new s;i.boundingSphereCheck=function(t,e){var i=c;return t.position.vsub(e.position,i),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>i.norm2()},i.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,e){function i(t,e,i,n,r){o.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=t||new s(100,100,100),this.aabbMax=e||new s((-100),(-100),(-100));var a=this.nx*this.ny*this.nz;if(0>=a)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var h=0;a>h;h++)this.bins[h]=[],this.binLengths[h]=0}e.exports=i;var o=t("./Broadphase"),s=t("../math/Vec3"),n=t("../shapes/Shape");i.prototype=new o,i.prototype.constructor=i;var r=new s;new s,i.prototype.collisionPairs=function(t,e,i){function o(t,e,i,o,s,n,r){var a=(t-g)*b|0,h=(e-E)*R|0,l=(i-x)*P|0,m=H((o-g)*b),y=H((s-E)*R),w=H((n-x)*P);0>a?a=0:a>=p&&(a=p-1),0>h?h=0:h>=c&&(h=c-1),0>l?l=0:l>=u&&(l=u-1),0>m?m=0:m>=p&&(m=p-1),0>y?y=0:y>=c&&(y=c-1),0>w?w=0:w>=u&&(w=u-1),a*=d,h*=v,l*=f,m*=d,y*=v,w*=f;for(var T=a;m>=T;T+=d)for(var M=h;y>=M;M+=v)for(var S=l;w>=S;S+=f){var B=T+M+S;V[B][F[B]++]=r}}for(var s=t.numObjects(),a=t.bodies,h=this.aabbMax,l=this.aabbMin,p=this.nx,c=this.ny,u=this.nz,d=c*u,v=u,f=1,m=h.x,y=h.y,w=h.z,g=l.x,E=l.y,x=l.z,b=p/(m-g),R=c/(y-E),P=u/(w-x),T=(m-g)/p,M=(y-E)/c,S=(w-x)/u,B=.5*Math.sqrt(T*T+M*M+S*S),z=n.types,A=z.SPHERE,C=z.PLANE,V=(z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON,this.bins),F=this.binLengths,I=this.bins.length,q=0;q!==I;q++)F[q]=0;for(var H=Math.ceil,l=Math.min,h=Math.max,q=0;q!==s;q++){var L=a[q],j=L.shape;switch(j.type){case A:var N=L.position.x,_=L.position.y,W=L.position.z,k=j.radius;o(N-k,_-k,W-k,N+k,_+k,W+k,L);break;case C:j.worldNormalNeedsUpdate&&j.computeWorldNormal(L.quaternion);var O=j.worldNormal,D=g+.5*T-L.position.x,Y=E+.5*M-L.position.y,U=x+.5*S-L.position.z,G=r;G.set(D,Y,U);for(var X=0,Q=0;X!==p;X++,Q+=d,G.y=Y,G.x+=T)for(var Z=0,K=0;Z!==c;Z++,K+=v,G.z=U,G.y+=M)for(var J=0,$=0;J!==u;J++,$+=f,G.z+=S)if(G.dot(O)<B){var tt=Q+K+$;V[tt][F[tt]++]=L}break;default:L.aabbNeedsUpdate&&L.computeAABB(),o(L.aabb.lowerBound.x,L.aabb.lowerBound.y,L.aabb.lowerBound.z,L.aabb.upperBound.x,L.aabb.upperBound.y,L.aabb.upperBound.z,L)}}for(var q=0;q!==I;q++){var et=F[q];if(et>1)for(var it=V[q],X=0;X!==et;X++)for(var L=it[X],Z=0;Z!==X;Z++){var ot=it[Z];this.needBroadphaseCollision(L,ot)&&this.intersectionTest(L,ot,e,i)}}this.makePairsUnique(e,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,e){function i(){o.apply(this)}e.exports=i;var o=t("./Broadphase"),s=t("./AABB");i.prototype=new o,i.prototype.constructor=i,i.prototype.collisionPairs=function(t,e,i){var o,s,n,r,a=t.bodies,h=a.length;for(o=0;o!==h;o++)for(s=0;s!==o;s++)n=a[o],r=a[s],this.needBroadphaseCollision(n,r)&&this.intersectionTest(n,r,e,i)},new s,i.prototype.aabbQuery=function(t,e,i){i=i||[];for(var o=0;o<t.bodies.length;o++){var s=t.bodies[o];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(e)&&i.push(s)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e){function i(){this.matrix={}}e.exports=i,i.prototype.get=function(t,e){if(t=t.id,e=e.id,e>t){var i=e;e=t,t=i}return t+"-"+e in this.matrix},i.prototype.set=function(t,e,i){if(t=t.id,e=e.id,e>t){var o=e;e=t,t=o}i?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(){}},{}],9:[function(t,e){function i(t,e){this.from=t?t.clone():new n,this.to=e?e.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=i.ANY,this.result=new h,this.hasHit=!1,this.callback=function(){}}function o(t,e,i,o){o.vsub(e,I),i.vsub(e,d),t.vsub(e,v);var s,n,r=I.dot(I),a=I.dot(d),h=I.dot(v),l=d.dot(d),p=d.dot(v);return(s=l*h-a*p)>=0&&(n=r*p-a*h)>=0&&r*l-a*a>s+n}function s(t,e,i){i.vsub(t,I);var o=I.dot(e);e.mult(o,q),q.vadd(t,q);var s=i.distanceTo(q);return s}e.exports=i;var n=t("../math/Vec3"),r=t("../math/Quaternion"),a=t("../math/Transform"),h=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),l=t("../shapes/Shape"),p=t("../collision/AABB");i.prototype.constructor=i,i.CLOSEST=1,i.ANY=2,i.ALL=4;var c=new p,u=[];i.prototype.intersectWorld=function(t,e){return this.mode=e.mode||i.ANY,this.result=e.result||new h,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask="undefined"!=typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!=typeof e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(c),u.length=0,t.broadphase.aabbQuery(t,c,u),this.intersectBodies(u),this.hasHit};var d=new n,v=new n;i.pointInTriangle=o;var f=new n,m=new r;i.prototype.intersectBody=function(t,e){e&&(this.result=e,this._updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&0!==(this.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&this.collisionFilterMask))for(var o=f,s=m,n=0,r=t.shapes.length;r>n;n++){var a=t.shapes[n];if((!i||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[n],s),t.quaternion.vmult(t.shapeOffsets[n],o),o.vadd(t.position,o),this.intersectShape(a,s,o,t),this.result._shouldStop))break}},i.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var i=0,o=t.length;!this.result._shouldStop&&o>i;i++)this.intersectBody(t[i])},i.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},i.prototype.intersectShape=function(t,e,i,o){var n=this.from,r=s(n,this._direction,i);if(!(r>t.boundingSphereRadius)){var a=this[t.type];a&&a.call(this,t,e,i,o)}};var y=(new n,new n,new n),w=new n,g=new n,E=new n;new n,new h,i.prototype.intersectBox=function(t,e,i,o){return this.intersectConvex(t.convexPolyhedronRepresentation,e,i,o)},i.prototype[l.types.BOX]=i.prototype.intersectBox,i.prototype.intersectPlane=function(t,e,i,o){var s=this.from,r=this.to,a=this._direction,h=new n(0,0,1);e.vmult(h,h);var l=new n;s.vsub(i,l);var p=l.dot(h);r.vsub(i,l);var c=l.dot(h);if(!(p*c>0||s.distanceTo(r)<p)){var u=h.dot(a);if(!(Math.abs(u)<this.precision)){var d=new n,v=new n,f=new n;s.vsub(i,d);var m=-h.dot(d)/u;a.scale(m,v),s.vadd(v,f),this.reportIntersection(h,f,t,o,-1)}}},i.prototype[l.types.PLANE]=i.prototype.intersectPlane,i.prototype.getAABB=function(t){var e=this.to,i=this.from;t.lowerBound.x=Math.min(e.x,i.x),t.lowerBound.y=Math.min(e.y,i.y),t.lowerBound.z=Math.min(e.z,i.z),t.upperBound.x=Math.max(e.x,i.x),t.upperBound.y=Math.max(e.y,i.y),t.upperBound.z=Math.max(e.z,i.z)};var x={faceList:[0]};i.prototype.intersectHeightfield=function(t,e,o,s){var r=(t.data,t.elementSize,new n),h=new i(this.from,this.to);a.pointToLocalFrame(o,e,h.from,h.from),a.pointToLocalFrame(o,e,h.to,h.to);var l=[],p=null,c=null,u=null,d=null,v=t.getIndexOfPosition(h.from.x,h.from.y,l,!1);if(v&&(p=l[0],c=l[1],u=l[0],d=l[1]),v=t.getIndexOfPosition(h.to.x,h.to.y,l,!1),v&&((null===p||l[0]<p)&&(p=l[0]),(null===u||l[0]>u)&&(u=l[0]),(null===c||l[1]<c)&&(c=l[1]),(null===d||l[1]>d)&&(d=l[1])),null!==p){var f=[];t.getRectMinMax(p,c,u,d,f);for(var m=(f[0],f[1],p);u>=m;m++)for(var y=c;d>=y;y++){if(this.result._shouldStop)return;if(t.getConvexTrianglePillar(m,y,!1),a.pointToWorldFrame(o,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,s,x),this.result._shouldStop)return;t.getConvexTrianglePillar(m,y,!0),a.pointToWorldFrame(o,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,s,x)}}},i.prototype[l.types.HEIGHTFIELD]=i.prototype.intersectHeightfield;var b=new n,R=new n;i.prototype.intersectSphere=function(t,e,i,o){var s=this.from,n=this.to,r=t.radius,a=Math.pow(n.x-s.x,2)+Math.pow(n.y-s.y,2)+Math.pow(n.z-s.z,2),h=2*((n.x-s.x)*(s.x-i.x)+(n.y-s.y)*(s.y-i.y)+(n.z-s.z)*(s.z-i.z)),l=Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)+Math.pow(s.z-i.z,2)-Math.pow(r,2),p=Math.pow(h,2)-4*a*l,c=b,u=R;if(!(0>p))if(0===p)s.lerp(n,p,c),c.vsub(i,u),u.normalize(),this.reportIntersection(u,c,t,o,-1);else{var d=(-h-Math.sqrt(p))/(2*a),v=(-h+Math.sqrt(p))/(2*a);if(d>=0&&1>=d&&(s.lerp(n,d,c),c.vsub(i,u),u.normalize(),this.reportIntersection(u,c,t,o,-1)),this.result._shouldStop)return;v>=0&&1>=v&&(s.lerp(n,v,c),c.vsub(i,u),u.normalize(),this.reportIntersection(u,c,t,o,-1))}},i.prototype[l.types.SPHERE]=i.prototype.intersectSphere;var P=new n,T=(new n,new n,new n);i.prototype.intersectConvex=function(t,e,i,s,n){for(var r=P,a=T,h=n&&n.faceList||null,l=t.faces,p=t.vertices,c=t.faceNormals,u=this._direction,d=this.from,v=this.to,f=d.distanceTo(v),m=h?h.length:l.length,x=this.result,b=0;!x._shouldStop&&m>b;b++){var R=h?h[b]:b,M=l[R],S=c[R],B=e,z=i;a.copy(p[M[0]]),B.vmult(a,a),a.vadd(z,a),a.vsub(d,a),B.vmult(S,r);var A=u.dot(r);if(!(Math.abs(A)<this.precision)){var C=r.dot(a)/A;if(!(0>C)){u.mult(C,y),y.vadd(d,y),w.copy(p[M[0]]),B.vmult(w,w),z.vadd(w,w);for(var V=1;!x._shouldStop&&V<M.length-1;V++){g.copy(p[M[V]]),E.copy(p[M[V+1]]),B.vmult(g,g),B.vmult(E,E),z.vadd(g,g),z.vadd(E,E);var F=y.distanceTo(d);!o(y,w,g,E)&&!o(y,g,w,E)||F>f||this.reportIntersection(r,y,t,s,R)}}}}},i.prototype[l.types.CONVEXPOLYHEDRON]=i.prototype.intersectConvex;var M=new n,S=new n,B=new n,z=new n,A=new n,C=new n,V=(new p,[]),F=new a;i.prototype.intersectTrimesh=function(t,e,i,s,n){var r=M,h=V,l=F,p=T,c=S,u=B,d=z,v=C,f=A,m=(n&&n.faceList||null,t.indices),x=(t.vertices,t.faceNormals,this.from),b=this.to,R=this._direction;l.position.copy(i),l.quaternion.copy(e),a.vectorToLocalFrame(i,e,R,c),a.pointToLocalFrame(i,e,x,u),a.pointToLocalFrame(i,e,b,d);var P=u.distanceSquared(d);t.tree.rayQuery(this,l,h);for(var I=0,q=h.length;!this.result._shouldStop&&I!==q;I++){var H=h[I];t.getNormal(H,r),t.getVertex(m[3*H],w),w.vsub(u,p);var L=c.dot(r),j=r.dot(p)/L;if(!(0>j)){c.scale(j,y),y.vadd(u,y),t.getVertex(m[3*H+1],g),t.getVertex(m[3*H+2],E);var N=y.distanceSquared(u);!o(y,g,w,E)&&!o(y,w,g,E)||N>P||(a.vectorToWorldFrame(e,r,f),a.pointToWorldFrame(i,e,y,v),this.reportIntersection(f,v,t,s,H))}}h.length=0},i.prototype[l.types.TRIMESH]=i.prototype.intersectTrimesh,i.prototype.reportIntersection=function(t,e,o,s,n){var r=this.from,a=this.to,h=r.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(l.hitFaceIndex="undefined"!=typeof n?n:-1,this.mode){case i.ALL:this.hasHit=!0,l.set(r,a,t,e,o,s,h),l.hasHit=!0,this.callback(l);break;case i.CLOSEST:(h<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(r,a,t,e,o,s,h));break;case i.ANY:this.hasHit=!0,l.hasHit=!0,l.set(r,a,t,e,o,s,h),l._shouldStop=!0}};var I=new n,q=new n},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,e){function i(){this.rayFromWorld=new o,this.rayToWorld=new o,this.hitNormalWorld=new o,this.hitPointWorld=new o,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var o=t("../math/Vec3");e.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(t,e,i,o,s,n,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(o),this.shape=s,this.body=n,this.distance=r}},{"../math/Vec3":30}],11:[function(t,e){function i(t){o.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var i=e.indexOf(t.body);-1!==i&&e.splice(i,1)},t&&this.setWorld(t)}var o=(t("../shapes/Shape"),t("../collision/Broadphase"));e.exports=i,i.prototype=new o,i.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},i.insertionSortX=function(t){for(var e=1,i=t.length;i>e;e++){for(var o=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.x<=o.aabb.lowerBound.x);s--)t[s+1]=t[s];t[s+1]=o}return t},i.insertionSortY=function(t){for(var e=1,i=t.length;i>e;e++){for(var o=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.y<=o.aabb.lowerBound.y);s--)t[s+1]=t[s];t[s+1]=o}return t},i.insertionSortZ=function(t){for(var e=1,i=t.length;i>e;e++){for(var o=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.z<=o.aabb.lowerBound.z);s--)t[s+1]=t[s];t[s+1]=o}return t},i.prototype.collisionPairs=function(t,e,o){var s,n,r=this.axisList,a=r.length,h=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),s=0;s!==a;s++){var l=r[s];for(n=s+1;a>n;n++){var p=r[n];if(this.needBroadphaseCollision(l,p)){if(!i.checkBounds(l,p,h))break;this.intersectionTest(l,p,e,o)}}}},i.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,o=t.length,s=0;s!==o;s++){var n=t[s];n.aabbNeedsUpdate&&n.computeAABB()}0===e?i.insertionSortX(t):1===e?i.insertionSortY(t):2===e&&i.insertionSortZ(t)},i.checkBounds=function(t,e,i){var o,s;0===i?(o=t.position.x,s=e.position.x):1===i?(o=t.position.y,s=e.position.y):2===i&&(o=t.position.z,s=e.position.z);var n=t.boundingRadius,r=e.boundingRadius,a=o+n,h=s-r;return a>h},i.prototype.autoDetectAxis=function(){for(var t=0,e=0,i=0,o=0,s=0,n=0,r=this.axisList,a=r.length,h=1/a,l=0;l!==a;l++){var p=r[l],c=p.position.x;t+=c,e+=c*c;var u=p.position.y;i+=u,o+=u*u;var d=p.position.z;s+=d,n+=d*d}var v=e-t*t*h,f=o-i*i*h,m=n-s*s*h;this.axisIndex=v>f?v>m?0:2:f>m?1:2},i.prototype.aabbQuery=function(t,e,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,s="x";1===o&&(s="y"),2===o&&(s="z");for(var n=this.axisList,r=(e.lowerBound[s],e.upperBound[s],0);r<n.length;r++){var a=n[r];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&i.push(a)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,e){function i(t,e,i){i=i||{};var a="undefined"!=typeof i.maxForce?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new r,l=i.pivotB?i.pivotB.clone():new r;this.axisA=i.axisA?i.axisA.clone():new r,this.axisB=i.axisB?i.axisB.clone():new r,o.call(this,t,h,e,l,a),this.collideConnected=!!i.collideConnected,this.angle="undefined"!=typeof i.angle?i.angle:0;var p=this.coneEquation=new s(t,e,i),c=this.twistEquation=new n(t,e,i);this.twistAngle="undefined"!=typeof i.twistAngle?i.twistAngle:0,p.maxForce=0,p.minForce=-a,c.maxForce=0,c.minForce=-a,this.equations.push(p,c)}e.exports=i;var o=(t("./Constraint"),t("./PointToPointConstraint")),s=t("../equations/ConeEquation"),n=t("../equations/RotationalEquation"),r=(t("../equations/ContactEquation"),t("../math/Vec3"));i.prototype=new o,i.constructor=i,new r,new r,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,s=this.twistEquation;o.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(s.axisA,s.axisA),t.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),e.vectorToWorldFrame(s.axisB,s.axisB),i.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,e){function i(t,e,s){s=o.defaults(s,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=i.idCounter++,this.collideConnected=s.collideConnected,s.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}e.exports=i;var o=t("../utils/Utils");i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},i.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},i.idCounter=0},{"../utils/Utils":53}],14:[function(t,e){function i(t,e,i,n){o.call(this,t,e),"undefined"==typeof i&&(i=t.position.distanceTo(e.position)),"undefined"==typeof n&&(n=1e6),this.distance=i;var r=this.distanceEquation=new s(t,e);this.equations.push(r),r.minForce=-n,r.maxForce=n}e.exports=i;var o=t("./Constraint"),s=t("../equations/ContactEquation");i.prototype=new o,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,o=.5*this.distance,s=i.ni;e.position.vsub(t.position,s),s.normalize(),s.mult(o,i.ri),s.mult(-o,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,e){function i(t,e,i){i=i||{};var a="undefined"!=typeof i.maxForce?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new r,l=i.pivotB?i.pivotB.clone():new r;o.call(this,t,h,e,l,a);var p=this.axisA=i.axisA?i.axisA.clone():new r(1,0,0);p.normalize();var c=this.axisB=i.axisB?i.axisB.clone():new r(1,0,0);c.normalize();var u=this.rotationalEquation1=new s(t,e,i),d=this.rotationalEquation2=new s(t,e,i),v=this.motorEquation=new n(t,e,a);v.enabled=!1,this.equations.push(u,d,v)}e.exports=i;var o=(t("./Constraint"),t("./PointToPointConstraint")),s=t("../equations/RotationalEquation"),n=t("../equations/RotationalMotorEquation"),r=(t("../equations/ContactEquation"),t("../math/Vec3"));i.prototype=new o,i.constructor=i,i.prototype.enableMotor=function(){this.motorEquation.enabled=!0},i.prototype.disableMotor=function(){this.motorEquation.enabled=!1},i.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},i.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var a=new r,h=new r;i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,s=this.rotationalEquation1,n=this.rotationalEquation2,r=a,l=h,p=this.axisA,c=this.axisB;o.prototype.update.call(this),t.quaternion.vmult(p,r),e.quaternion.vmult(c,l),r.tangents(s.axisA,n.axisA),s.axisB.copy(l),n.axisB.copy(l),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,e){function i(t,e,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6,a=new n,h=new n,l=new n;t.position.vadd(e.position,l),l.scale(.5,l),e.pointToLocalFrame(l,h),t.pointToLocalFrame(l,a),o.call(this,t,a,e,h,r);var p=this.rotationalEquation1=new s(t,e,i),c=this.rotationalEquation2=new s(t,e,i),u=this.rotationalEquation3=new s(t,e,i);this.equations.push(p,c,u)}e.exports=i;var o=(t("./Constraint"),t("./PointToPointConstraint")),s=t("../equations/RotationalEquation"),n=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));i.prototype=new o,i.constructor=i,new n,new n,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),s=this.rotationalEquation2,r=this.rotationalEquation3;o.prototype.update.call(this),t.vectorToWorldFrame(n.UNIT_X,i.axisA),e.vectorToWorldFrame(n.UNIT_Y,i.axisB),t.vectorToWorldFrame(n.UNIT_Y,s.axisA),e.vectorToWorldFrame(n.UNIT_Z,s.axisB),t.vectorToWorldFrame(n.UNIT_Z,r.axisA),e.vectorToWorldFrame(n.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,e){function i(t,e,i,r,a){o.call(this,t,i),a="undefined"!=typeof a?a:1e6,this.pivotA=e?e.clone():new n,this.pivotB=r?r.clone():new n;var h=this.equationX=new s(t,i),l=this.equationY=new s(t,i),p=this.equationZ=new s(t,i);this.equations.push(h,l,p),h.minForce=l.minForce=p.minForce=-a,h.maxForce=l.maxForce=p.maxForce=a,h.ni.set(1,0,0),l.ni.set(0,1,0),p.ni.set(0,0,1)}e.exports=i;var o=t("./Constraint"),s=t("../equations/ContactEquation"),n=t("../math/Vec3");i.prototype=new o,i.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.equationX,o=this.equationY,s=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj),s.ri.copy(i.ri),s.rj.copy(i.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,e){function i(t,e,i){i=i||{};var n="undefined"!=typeof i.maxForce?i.maxForce:1e6;s.call(this,t,e,-n,n),this.axisA=i.axisA?i.axisA.clone():new o(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o(0,1,0),this.angle="undefined"!=typeof i.angle?i.angle:0}e.exports=i;var o=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));i.prototype=new s,i.prototype.constructor=i;var n=new o,r=new o;i.prototype.computeB=function(t){var e=this.a,i=this.b,o=this.axisA,s=this.axisB,a=n,h=r,l=this.jacobianElementA,p=this.jacobianElementB;o.cross(s,a),s.cross(o,h),l.rotational.copy(h),p.rotational.copy(a);var c=Math.cos(this.angle)-o.dot(s),u=this.computeGW(),d=this.computeGiMf(),v=-c*e-u*i-t*d;return v}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,e){function i(t,e,i){i="undefined"!=typeof i?i:1e6,o.call(this,t,e,0,i),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}e.exports=i;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3"),i.prototype=new o,i.prototype.constructor=i;var n=new s,r=new s,a=new s;i.prototype.computeB=function(t){var e=this.a,i=this.b,o=this.bi,s=this.bj,h=this.ri,l=this.rj,p=n,c=r,u=o.velocity,d=o.angularVelocity,v=(o.force,o.torque,s.velocity),f=s.angularVelocity,m=(s.force,s.torque,a),y=this.jacobianElementA,w=this.jacobianElementB,g=this.ni;h.cross(g,p),l.cross(g,c),g.negate(y.spatial),p.negate(y.rotational),w.spatial.copy(g),w.rotational.copy(c),m.copy(s.position),m.vadd(l,m),m.vsub(o.position,m),m.vsub(h,m);var E=g.dot(m),x=this.restitution+1,b=x*v.dot(g)-x*u.dot(g)+f.dot(c)-d.dot(p),R=this.computeGiMf(),P=-E*e-b*i-t*R;return P};var h=new s,l=new s,p=new s,c=new s,u=new s;i.prototype.getImpactVelocityAlongNormal=function(){var t=h,e=l,i=p,o=c,s=u;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,o),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(o,e),t.vsub(e,s),this.ni.dot(s)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,e){function i(t,e,s,n){this.id=i.id++,this.minForce="undefined"==typeof s?-1e6:s,
this.maxForce="undefined"==typeof n?1e6:n,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new o,this.jacobianElementB=new o,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}e.exports=i;var o=t("../math/JacobianElement"),s=t("../math/Vec3");i.prototype.constructor=i,i.id=0,i.prototype.setSpookParams=function(t,e,i){var o=e,s=t,n=i;this.a=4/(n*(1+4*o)),this.b=4*o/(1+4*o),this.eps=4/(n*n*s*(1+4*o))},i.prototype.computeB=function(t,e,i){var o=this.computeGW(),s=this.computeGq(),n=this.computeGiMf();return-s*t-o*e-n*i},i.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,s=i.position,n=o.position;return t.spatial.dot(s)+e.spatial.dot(n)};var n=new s;i.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,s=i.velocity,r=o.velocity,a=i.angularVelocity||n,h=o.angularVelocity||n;return t.multiplyVectors(s,a)+e.multiplyVectors(r,h)},i.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,s=i.vlambda,r=o.vlambda,a=i.wlambda||n,h=o.wlambda||n;return t.multiplyVectors(s,a)+e.multiplyVectors(r,h)};var r=new s,a=new s,h=new s,l=new s;i.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,s=i.force,n=i.torque,p=o.force,c=o.torque,u=i.invMassSolve,d=o.invMassSolve;return i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(n,h):h.set(0,0,0),o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(c,l):l.set(0,0,0),s.mult(u,r),p.mult(d,a),t.multiplyVectors(r,h)+e.multiplyVectors(a,l)};var p=new s;i.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,o=this.bj,s=i.invMassSolve,n=o.invMassSolve,r=i.invInertiaWorldSolve,a=o.invInertiaWorldSolve,h=s+n;return r&&(r.vmult(t.rotational,p),h+=p.dot(t.rotational)),a&&(a.vmult(e.rotational,p),h+=p.dot(e.rotational)),h};var c=new s;new s,new s,new s,new s,new s,i.prototype.addToWlambda=function(t){var e=this.jacobianElementA,i=this.jacobianElementB,o=this.bi,s=this.bj,n=c;e.spatial.mult(o.invMassSolve*t,n),o.vlambda.vadd(n,o.vlambda),i.spatial.mult(s.invMassSolve*t,n),s.vlambda.vadd(n,s.vlambda),o.invInertiaWorldSolve&&(o.invInertiaWorldSolve.vmult(e.rotational,n),n.mult(t,n),o.wlambda.vadd(n,o.wlambda)),s.invInertiaWorldSolve&&(s.invInertiaWorldSolve.vmult(i.rotational,n),n.mult(t,n),s.wlambda.vadd(n,s.wlambda))},i.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,e){function i(t,e,i){o.call(this,t,e,-i,i),this.ri=new s,this.rj=new s,this.t=new s}e.exports=i;var o=t("./Equation"),s=t("../math/Vec3");t("../math/Mat3"),i.prototype=new o,i.prototype.constructor=i;var n=new s,r=new s;i.prototype.computeB=function(t){var e=(this.a,this.b),i=(this.bi,this.bj,this.ri),o=this.rj,s=n,a=r,h=this.t;i.cross(h,s),o.cross(h,a);var l=this.jacobianElementA,p=this.jacobianElementB;h.negate(l.spatial),s.negate(l.rotational),p.spatial.copy(h),p.rotational.copy(a);var c=this.computeGW(),u=this.computeGiMf(),d=-c*e-t*u;return d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,e){function i(t,e,i){i=i||{};var n="undefined"!=typeof i.maxForce?i.maxForce:1e6;s.call(this,t,e,-n,n),this.axisA=i.axisA?i.axisA.clone():new o(1,0,0),this.axisB=i.axisB?i.axisB.clone():new o(0,1,0),this.maxAngle=Math.PI/2}e.exports=i;var o=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));i.prototype=new s,i.prototype.constructor=i;var n=new o,r=new o;i.prototype.computeB=function(t){var e=this.a,i=this.b,o=this.axisA,s=this.axisB,a=n,h=r,l=this.jacobianElementA,p=this.jacobianElementB;o.cross(s,a),s.cross(o,h),l.rotational.copy(h),p.rotational.copy(a);var c=Math.cos(this.maxAngle)-o.dot(s),u=this.computeGW(),d=this.computeGiMf(),v=-c*e-u*i-t*d;return v}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,e){function i(t,e,i){i="undefined"!=typeof i?i:1e6,s.call(this,t,e,-i,i),this.axisA=new o,this.axisB=new o,this.targetVelocity=0}e.exports=i;var o=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));i.prototype=new s,i.prototype.constructor=i,i.prototype.computeB=function(t){var e=(this.a,this.b),i=(this.bi,this.bj,this.axisA),o=this.axisB,s=this.jacobianElementA,n=this.jacobianElementB;s.rotational.copy(i),o.negate(n.rotational);var r=this.computeGW()-this.targetVelocity,a=this.computeGiMf(),h=-r*e-t*a;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,e){function i(t,e,s){s=o.defaults(s,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[t,e],this.friction=s.friction,this.restitution=s.restitution,this.contactEquationStiffness=s.contactEquationStiffness,this.contactEquationRelaxation=s.contactEquationRelaxation,this.frictionEquationStiffness=s.frictionEquationStiffness,this.frictionEquationRelaxation=s.frictionEquationRelaxation}var o=t("../utils/Utils");e.exports=i,i.idCounter=0},{"../utils/Utils":53}],25:[function(t,e){function i(t){var e="";t=t||{},"string"==typeof t?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=i.idCounter++,this.friction="undefined"!=typeof t.friction?t.friction:-1,this.restitution="undefined"!=typeof t.restitution?t.restitution:-1}e.exports=i,i.idCounter=0},{}],26:[function(t,e){function i(){this.spatial=new o,this.rotational=new o}e.exports=i;var o=t("./Vec3");i.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,e){function i(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]}e.exports=i;var o=t("./Vec3");i.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},i.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},i.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},i.prototype.getTrace=function(t){var t=t||new o,e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},i.prototype.vmult=function(t,e){e=e||new o;var i=this.elements,s=t.x,n=t.y,r=t.z;return e.x=i[0]*s+i[1]*n+i[2]*r,e.y=i[3]*s+i[4]*n+i[5]*r,e.z=i[6]*s+i[7]*n+i[8]*r,e},i.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},i.prototype.mmult=function(t,e){for(var o=e||new i,s=0;3>s;s++)for(var n=0;3>n;n++){for(var r=0,a=0;3>a;a++)r+=t.elements[s+3*a]*this.elements[a+3*n];o.elements[s+3*n]=r}return o},i.prototype.scale=function(t,e){e=e||new i;for(var o=this.elements,s=e.elements,n=0;3!==n;n++)s[3*n+0]=t.x*o[3*n+0],s[3*n+1]=t.y*o[3*n+1],s[3*n+2]=t.z*o[3*n+2];return e},i.prototype.solve=function(t,e){e=e||new o;for(var i=3,s=4,n=[],r=0;i*s>r;r++)n.push(0);var r,a;for(r=0;3>r;r++)for(a=0;3>a;a++)n[r+s*a]=this.elements[r+3*a];n[3]=t.x,n[7]=t.y,n[11]=t.z;var h,l,p=3,c=p,u=4;do{if(r=c-p,0===n[r+s*r])for(a=r+1;c>a;a++)if(0!==n[r+s*a]){h=u;do l=u-h,n[l+s*r]+=n[l+s*a];while(--h);break}if(0!==n[r+s*r])for(a=r+1;c>a;a++){var d=n[r+s*a]/n[r+s*r];h=u;do l=u-h,n[l+s*a]=r>=l?0:n[l+s*a]-n[l+s*r]*d;while(--h)}}while(--p);if(e.z=n[2*s+3]/n[2*s+2],e.y=(n[1*s+3]-n[1*s+2]*e.z)/n[1*s+1],e.x=(n[0*s+3]-n[0*s+2]*e.z-n[0*s+1]*e.y)/n[0*s+0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||1/0===e.x||1/0===e.y||1/0===e.z)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},i.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:void(this.elements[e+3*t]=i)},i.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},i.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},i.prototype.reverse=function(t){t=t||new i;for(var e=3,o=6,s=[],n=0;e*o>n;n++)s.push(0);var n,r;for(n=0;3>n;n++)for(r=0;3>r;r++)s[n+o*r]=this.elements[n+3*r];s[3]=1,s[9]=0,s[15]=0,s[4]=0,s[10]=1,s[16]=0,s[5]=0,s[11]=0,s[17]=1;var a,h,l=3,p=l,c=o;do{if(n=p-l,0===s[n+o*n])for(r=n+1;p>r;r++)if(0!==s[n+o*r]){a=c;do h=c-a,s[h+o*n]+=s[h+o*r];while(--a);break}if(0!==s[n+o*n])for(r=n+1;p>r;r++){var u=s[n+o*r]/s[n+o*n];a=c;do h=c-a,s[h+o*r]=n>=h?0:s[h+o*r]-s[h+o*n]*u;while(--a)}}while(--l);n=2;do{r=n-1;do{var u=s[n+o*r]/s[n+o*n];a=o;do h=o-a,s[h+o*r]=s[h+o*r]-s[h+o*n]*u;while(--a)}while(r--)}while(--n);n=2;do{var u=1/s[n+o*n];a=o;do h=o-a,s[h+o*n]=s[h+o*n]*u;while(--a)}while(n--);n=2;do{r=2;do{if(h=s[e+r+o*n],isNaN(h)||1/0===h)throw"Could not reverse! A=["+this.toString()+"]";t.e(n,r,h)}while(r--)}while(n--);return t},i.prototype.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,o=t.z,s=t.w,n=e+e,r=i+i,a=o+o,h=e*n,l=e*r,p=e*a,c=i*r,u=i*a,d=o*a,v=s*n,f=s*r,m=s*a,y=this.elements;return y[0]=1-(c+d),y[1]=l-m,y[2]=p+f,y[3]=l+m,y[4]=1-(h+d),y[5]=u-v,y[6]=p-f,y[7]=u+v,y[8]=1-(h+c),this},i.prototype.transpose=function(t){t=t||new i;for(var e=t.elements,o=this.elements,s=0;3!==s;s++)for(var n=0;3!==n;n++)e[3*s+n]=o[3*n+s];return t}},{"./Vec3":30}],28:[function(t,e){function i(t,e,i,o){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==o?o:1}e.exports=i;var o=t("./Vec3");i.prototype.set=function(t,e,i,o){this.x=t,this.y=e,this.z=i,this.w=o},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},i.prototype.toAxisAngle=function(t){t=t||new o,this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return.001>i?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]};var s=new o,n=new o;i.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var i=s,o=n;t.tangents(i,o),this.setFromAxisAngle(i,Math.PI)}else{var r=t.cross(e);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}};var r=new o,a=new o,h=new o;i.prototype.mult=function(t,e){e=e||new i;var o=this.w,s=r,n=a,l=h;return s.set(this.x,this.y,this.z),n.set(t.x,t.y,t.z),e.w=o*t.w-s.dot(n),s.cross(n,l),e.x=o*n.x+t.w*s.x+l.x,e.y=o*n.y+t.w*s.y+l.y,e.z=o*n.z+t.w*s.z+l.z,e},i.prototype.inverse=function(t){var e=this.x,o=this.y,s=this.z,n=this.w;t=t||new i,this.conjugate(t);var r=1/(e*e+o*o+s*s+n*n);return t.x*=r,t.y*=r,t.z*=r,t.w*=r,t},i.prototype.conjugate=function(t){return t=t||new i,t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},i.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},i.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},i.prototype.vmult=function(t,e){e=e||new o;var i=t.x,s=t.y,n=t.z,r=this.x,a=this.y,h=this.z,l=this.w,p=l*i+a*n-h*s,c=l*s+h*i-r*n,u=l*n+r*s-a*i,d=-r*i-a*s-h*n;return e.x=p*l+d*-r+c*-h-u*-a,e.y=c*l+d*-a+u*-r-p*-h,e.z=u*l+d*-h+p*-a-c*-r,e},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},i.prototype.toEuler=function(t,e){e=e||"YZX";var i,o,s,n=this.x,r=this.y,a=this.z,h=this.w;switch(e){case"YZX":var l=n*r+a*h;if(l>.499&&(i=2*Math.atan2(n,h),o=Math.PI/2,s=0),-.499>l&&(i=-2*Math.atan2(n,h),o=-Math.PI/2,s=0),isNaN(i)){var p=n*n,c=r*r,u=a*a;i=Math.atan2(2*r*h-2*n*a,1-2*c-2*u),o=Math.asin(2*l),s=Math.atan2(2*n*h-2*r*a,1-2*p-2*u)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=o,t.x=s},i.prototype.setFromEuler=function(t,e,i,o){o=o||"XYZ";var s=Math.cos(t/2),n=Math.cos(e/2),r=Math.cos(i/2),a=Math.sin(t/2),h=Math.sin(e/2),l=Math.sin(i/2);return"XYZ"===o?(this.x=a*n*r+s*h*l,this.y=s*h*r-a*n*l,this.z=s*n*l+a*h*r,this.w=s*n*r-a*h*l):"YXZ"===o?(this.x=a*n*r+s*h*l,this.y=s*h*r-a*n*l,this.z=s*n*l-a*h*r,this.w=s*n*r+a*h*l):"ZXY"===o?(this.x=a*n*r-s*h*l,this.y=s*h*r+a*n*l,this.z=s*n*l+a*h*r,this.w=s*n*r-a*h*l):"ZYX"===o?(this.x=a*n*r-s*h*l,this.y=s*h*r+a*n*l,this.z=s*n*l-a*h*r,this.w=s*n*r+a*h*l):"YZX"===o?(this.x=a*n*r+s*h*l,this.y=s*h*r+a*n*l,this.z=s*n*l-a*h*r,this.w=s*n*r-a*h*l):"XZY"===o&&(this.x=a*n*r-s*h*l,this.y=s*h*r-a*n*l,this.z=s*n*l+a*h*r,this.w=s*n*r+a*h*l),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,e){function i(t){t=t||{},this.position=new o,t.position&&this.position.copy(t.position),this.quaternion=new s,t.quaternion&&this.quaternion.copy(t.quaternion)}var o=t("./Vec3"),s=t("./Quaternion");e.exports=i;var n=new s;i.pointToLocalFrame=function(t,e,i,s){var s=s||new o;return i.vsub(t,s),e.conjugate(n),n.vmult(s,s),s},i.prototype.pointToLocal=function(t,e){return i.pointToLocalFrame(this.position,this.quaternion,t,e)},i.pointToWorldFrame=function(t,e,i,s){var s=s||new o;return e.vmult(i,s),s.vadd(t,s),s},i.prototype.pointToWorld=function(t,e){return i.pointToWorldFrame(this.position,this.quaternion,t,e)},i.prototype.vectorToWorldFrame=function(t,e){var e=e||new o;return this.quaternion.vmult(t,e),e},i.vectorToWorldFrame=function(t,e,i){return t.vmult(e,i),i},i.vectorToLocalFrame=function(t,e,i,s){var s=s||new o;return e.w*=-1,e.vmult(i,s),e.w*=-1,s}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,e){function i(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}e.exports=i;var o=t("./Mat3");i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(t,e){var o=t.x,s=t.y,n=t.z,r=this.x,a=this.y,h=this.z;return e=e||new i,e.x=a*n-h*s,e.y=h*o-r*n,e.z=r*s-a*o,e},i.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(t,e){return e?(e.x=t.x+this.x,e.y=t.y+this.y,void(e.z=t.z+this.z)):new i(this.x+t.x,this.y+t.y,this.z+t.z)},i.prototype.vsub=function(t,e){return e?(e.x=this.x-t.x,e.y=this.y-t.y,void(e.z=this.z-t.z)):new i(this.x-t.x,this.y-t.y,this.z-t.z)},i.prototype.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,o=Math.sqrt(t*t+e*e+i*i);if(o>0){var s=1/o;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return o},i.prototype.unit=function(t){t=t||new i;var e=this.x,o=this.y,s=this.z,n=Math.sqrt(e*e+o*o+s*s);return n>0?(n=1/n,t.x=e*n,t.y=o*n,t.z=s*n):(t.x=1,t.y=0,t.z=0),t},i.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(t){var e=this.x,i=this.y,o=this.z,s=t.x,n=t.y,r=t.z;return Math.sqrt((s-e)*(s-e)+(n-i)*(n-i)+(r-o)*(r-o))},i.prototype.distanceSquared=function(t){var e=this.x,i=this.y,o=this.z,s=t.x,n=t.y,r=t.z;return(s-e)*(s-e)+(n-i)*(n-i)+(r-o)*(r-o)},i.prototype.mult=function(t,e){e=e||new i;var o=this.x,s=this.y,n=this.z;return e.x=t*o,e.y=t*s,e.z=t*n,e},i.prototype.scale=i.prototype.mult,i.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(t){return t=t||new i,t.x=-this.x,t.y=-this.y,t.z=-this.z,t};var s=new i,n=new i;i.prototype.tangents=function(t,e){var i=this.norm();if(i>0){var o=s,r=1/i;o.set(this.x*r,this.y*r,this.z*r);var a=n;Math.abs(o.x)<.9?(a.set(1,0,0),o.cross(a,t)):(a.set(0,1,0),o.cross(a,t)),o.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.prototype.lerp=function(t,e,i){var o=this.x,s=this.y,n=this.z;i.x=o+(t.x-o)*e,i.y=s+(t.y-s)*e,i.z=n+(t.z-n)*e},i.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},i.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var r=new i;i.prototype.isAntiparallelTo=function(t,e){return this.negate(r),r.almostEquals(t,e)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,e){function i(t){t=t||{},o.apply(this),this.id=i.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,t.position&&this.position.copy(t.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new s,this.force=new s;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=0>=e?i.STATIC:i.DYNAMIC,typeof t.type==typeof i.STATIC&&(this.type=t.type),this.allowSleep="undefined"==typeof t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit="undefined"!=typeof t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!=typeof t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new r,t.quaternion&&this.quaternion.copy(t.quaternion),this.initQuaternion=new r,this.angularVelocity=new s,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new n,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new n,this.fixedRotation="undefined"!=typeof t.fixedRotation&&t.fixedRotation,this.angularDamping="undefined"!=typeof t.angularDamping?t.angularDamping:.01,this.aabb=new a,this.aabbNeedsUpdate=!0,this.wlambda=new s,t.shape&&this.addShape(t.shape),this.updateMassProperties()}e.exports=i;var o=t("../utils/EventTarget"),s=(t("../shapes/Shape"),t("../math/Vec3")),n=t("../math/Mat3"),r=t("../math/Quaternion"),a=(t("../material/Material"),t("../collision/AABB")),h=t("../shapes/Box");i.prototype=new o,i.prototype.constructor=i,i.DYNAMIC=1,i.STATIC=2,i.KINEMATIC=4,i.AWAKE=0,i.SLEEPY=1,i.SLEEPING=2,i.idCounter=0,i.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,t===i.SLEEPING&&this.dispatchEvent({type:"wakeup"})},i.prototype.sleep=function(){this.sleepState=i.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},i.sleepyEvent={type:"sleepy"},i.sleepEvent={type:"sleep"},i.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,o=this.velocity.norm2()+this.angularVelocity.norm2(),s=Math.pow(this.sleepSpeedLimit,2);e===i.AWAKE&&s>o?(this.sleepState=i.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(i.sleepyEvent)):e===i.SLEEPY&&o>s?this.wakeUp():e===i.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(i.sleepEvent))}},i.prototype.updateSolveMassProperties=function(){this.sleepState===i.SLEEPING||this.type===i.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},i.prototype.pointToLocalFrame=function(t,e){var e=e||new s;return t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},i.prototype.vectorToLocalFrame=function(t,e){var e=e||new s;return this.quaternion.conjugate().vmult(t,e),e},i.prototype.pointToWorldFrame=function(t,e){var e=e||new s;return this.quaternion.vmult(t,e),e.vadd(this.position,e),e},i.prototype.vectorToWorldFrame=function(t,e){var e=e||new s;return this.quaternion.vmult(t,e),e};var l=new s,p=new r;i.prototype.addShape=function(t,e,i){var o=new s,n=new r;return e&&o.copy(e),i&&n.copy(i),this.shapes.push(t),this.shapeOffsets.push(o),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},i.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,o=0,s=0;s!==i;s++){var n=t[s];n.updateBoundingSphereRadius();var r=e[s].norm(),a=n.boundingSphereRadius;r+a>o&&(o=r+a)}this.boundingRadius=o};var c=new a;i.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,o=t.length,s=l,n=p,r=this.quaternion,a=this.aabb,h=c,u=0;u!==o;u++){var d=t[u];i[u].mult(r,n),n.vmult(e[u],s),s.vadd(this.position,s),d.calculateWorldAABB(s,n,h.lowerBound,h.upperBound),0===u?a.copy(h):a.extend(h)}this.aabbNeedsUpdate=!1};var u=new n,d=new n;new n,i.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var i=u,o=d;i.setRotationFromQuaternion(this.quaternion),i.transpose(o),i.scale(e,i),i.mmult(o,this.invInertiaWorld)}};var v=new s,f=new s;i.prototype.applyForce=function(t,e){if(this.type===i.DYNAMIC){var o=v;e.vsub(this.position,o);var s=f;o.cross(t,s),this.force.vadd(t,this.force),this.torque.vadd(s,this.torque)}};var m=new s,y=new s;i.prototype.applyLocalForce=function(t,e){if(this.type===i.DYNAMIC){var o=m,s=y;this.vectorToWorldFrame(t,o),this.pointToWorldFrame(e,s),this.applyForce(o,s)}};var w=new s,g=new s,E=new s;i.prototype.applyImpulse=function(t,e){if(this.type===i.DYNAMIC){var o=w;e.vsub(this.position,o);var s=g;s.copy(t),s.mult(this.invMass,s),this.velocity.vadd(s,this.velocity);var n=E;o.cross(t,n),this.invInertiaWorld.vmult(n,n),this.angularVelocity.vadd(n,this.angularVelocity)}};var x=new s,b=new s;i.prototype.applyLocalImpulse=function(t,e){if(this.type===i.DYNAMIC){var o=x,s=b;this.vectorToWorldFrame(t,o),this.pointToWorldFrame(e,s),this.applyImpulse(o,s)}};var R=new s;i.prototype.updateMassProperties=function(){var t=R;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),h.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)},i.prototype.getVelocityAtWorldPoint=function(t,e){var i=new s;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,e){function i(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!=typeof t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis="undefined"!=typeof t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis="undefined"!=typeof t.indexUpAxis?t.indexUpAxis:2}function o(t,e,i,o,n){var r=0,a=i,h=E,l=x,p=b;t.getVelocityAtWorldPoint(a,h),e.getVelocityAtWorldPoint(a,l),h.vsub(l,p);var c=o.dot(p),u=s(t,i,o),d=s(e,i,o),v=1,f=v/(u+d);return r=-c*f,r>n&&(r=n),-n>r&&(r=-n),r}function s(t,e,i){var o=R,s=P,n=T,r=M;return e.vsub(t.position,o),o.cross(i,s),t.invInertiaWorld.vmult(s,r),r.cross(o,n),t.invMass+i.dot(n)}function n(t,e,i,o,s,n){var r=s.norm2();if(r>1.1)return 0;var a=S,h=B,l=z;t.getVelocityAtWorldPoint(e,a),i.getVelocityAtWorldPoint(o,h),a.vsub(h,l);var p=s.dot(l),c=.2,u=1/(t.invMass+i.invMass),n=-c*p*u;return n}var r=(t("./Body"),t("../math/Vec3")),a=t("../math/Quaternion"),h=(t("../collision/RaycastResult"),t("../collision/Ray")),l=t("../objects/WheelInfo");e.exports=i;var p=(new r,new r,new r,new r),c=new r,u=new r;new h,i.prototype.addWheel=function(t){t=t||{};var e=new l(t),i=this.wheelInfos.length;return this.wheelInfos.push(e),i},i.prototype.setSteeringValue=function(t,e){var i=this.wheelInfos[e];i.steering=t},new r,i.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},i.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},i.prototype.addToWorld=function(t){this.constraints,t.add(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},i.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},i.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,o=this.chassisBody,s=0;i>s;s++)this.updateWheelTransform(s);this.currentVehicleSpeedKmHour=3.6*o.velocity.norm();var n=new r;this.getVehicleAxisWorld(this.indexForwardAxis,n),n.dot(o.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var s=0;i>s;s++)this.castRay(e[s]);this.updateSuspension(t);for(var a=new r,h=new r,s=0;i>s;s++){var l=e[s],p=l.suspensionForce;p>l.maxSuspensionForce&&(p=l.maxSuspensionForce),l.raycastResult.hitNormalWorld.scale(p*t,a),l.raycastResult.hitPointWorld.vsub(o.position,h),o.applyImpulse(a,l.raycastResult.hitPointWorld)}this.updateFriction(t);var c=new r,u=new r,d=new r;for(s=0;i>s;s++){var l=e[s];o.getVelocityAtWorldPoint(l.chassisConnectionPointWorld,d);var v=1;switch(this.indexUpAxis){case 1:v=-1}if(l.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(l.raycastResult.hitNormalWorld);l.raycastResult.hitNormalWorld.scale(f,c),u.vsub(c,u);var m=u.dot(d);l.deltaRotation=v*m*t/l.radius}!l.sliding&&l.isInContact||0===l.engineForce||!l.useCustomSlidingRotationalSpeed||(l.deltaRotation=(l.engineForce>0?1:-1)*l.customSlidingRotationalSpeed*t),Math.abs(l.brake)>Math.abs(l.engineForce)&&(l.deltaRotation=0),l.rotation+=l.deltaRotation,l.deltaRotation*=.99}},i.prototype.updateSuspension=function(){for(var t=this.chassisBody,e=t.mass,i=this.wheelInfos,o=i.length,s=0;o>s;s++){var n=i[s];if(n.isInContact){var r,a=n.suspensionRestLength,h=n.suspensionLength,l=a-h;r=n.suspensionStiffness*l*n.clippedInvContactDotSuspension;var p,c=n.suspensionRelativeVelocity;p=0>c?n.dampingCompression:n.dampingRelaxation,r-=p*c,n.suspensionForce=r*e,n.suspensionForce<0&&(n.suspensionForce=0)}else n.suspensionForce=0}},i.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var d=new r,v=new r;i.prototype.castRay=function(t){var e=d,i=v;this.updateWheelTransformWorld(t);var o=this.chassisBody,s=-1,n=t.suspensionRestLength+t.radius;t.directionWorld.scale(n,e);var a=t.chassisConnectionPointWorld;a.vadd(e,i);var h=t.raycastResult;h.reset();var l=o.collisionResponse;o.collisionResponse=!1,this.world.rayTest(a,i,h),o.collisionResponse=l;var p=h.body;if(t.raycastResult.groundObject=0,p){s=h.distance,t.raycastResult.hitNormalWorld=h.hitNormalWorld,t.isInContact=!0;var c=h.distance;t.suspensionLength=c-t.radius;var u=t.suspensionRestLength-t.maxSuspensionTravel,f=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<u&&(t.suspensionLength=u),t.suspensionLength>f&&(t.suspensionLength=f,t.raycastResult.reset());var m=t.raycastResult.hitNormalWorld.dot(t.directionWorld),y=new r;o.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,y);var w=t.raycastResult.hitNormalWorld.dot(y);if(m>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var g=-1/m;t.suspensionRelativeVelocity=w*g,t.clippedInvContactDotSuspension=g}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return s},i.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},i.prototype.updateWheelTransform=function(t){var e=p,i=c,o=u,s=this.wheelInfos[t];this.updateWheelTransformWorld(s),s.directionLocal.scale(-1,e),i.copy(s.axleLocal),e.cross(i,o),o.normalize(),i.normalize();var n=s.steering,r=new a;r.setFromAxisAngle(e,n);var h=new a;h.setFromAxisAngle(i,s.rotation);var l=s.worldTransform.quaternion;this.chassisBody.quaternion.mult(r,l),l.mult(h,l),l.normalize();var d=s.worldTransform.position;d.copy(s.directionWorld),d.scale(s.suspensionLength,d),d.vadd(s.chassisConnectionPointWorld,d)};var f=[new r(1,0,0),new r(0,1,0),new r(0,0,1)];i.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var m=new r,y=[],w=[],g=1;i.prototype.updateFriction=function(t){for(var e=m,i=this.wheelInfos,s=i.length,a=this.chassisBody,h=w,l=y,p=0,c=0;s>c;c++){var u=i[c],d=u.raycastResult.body;d&&p++,u.sideImpulse=0,u.forwardImpulse=0,h[c]||(h[c]=new r),l[c]||(l[c]=new r)}for(var c=0;s>c;c++){var u=i[c],d=u.raycastResult.body;if(d){var v=l[c],E=this.getWheelTransformWorld(c);E.vectorToWorldFrame(f[this.indexRightAxis],v);var x=u.raycastResult.hitNormalWorld,b=v.dot(x);x.scale(b,e),v.vsub(e,v),v.normalize(),x.cross(v,h[c]),h[c].normalize(),u.sideImpulse=n(a,u.raycastResult.hitPointWorld,d,u.raycastResult.hitPointWorld,v),u.sideImpulse*=g}}var R=1,P=.5;this.sliding=!1;for(var c=0;s>c;c++){var u=i[c],d=u.raycastResult.body,T=0;if(u.slipInfo=1,d){var M=0,S=u.brake?u.brake:M;T=o(a,d,u.raycastResult.hitPointWorld,h[c],S),T+=u.engineForce*t;var B=S/T;u.slipInfo*=B}if(u.forwardImpulse=0,u.skidInfo=1,d){u.skidInfo=1;var z=u.suspensionForce*t*u.frictionSlip,A=z,C=z*A;u.forwardImpulse=T;var V=u.forwardImpulse*P,F=u.sideImpulse*R,I=V*V+F*F;if(u.sliding=!1,I>C){this.sliding=!0,u.sliding=!0;var B=z/Math.sqrt(I);u.skidInfo*=B}}}if(this.sliding)for(var c=0;s>c;c++){var u=i[c];0!==u.sideImpulse&&u.skidInfo<1&&(u.forwardImpulse*=u.skidInfo,u.sideImpulse*=u.skidInfo)}for(var c=0;s>c;c++){var u=i[c],q=new r;if(q.copy(u.raycastResult.hitPointWorld),0!==u.forwardImpulse){var H=new r;h[c].scale(u.forwardImpulse,H),a.applyImpulse(H,q)}if(0!==u.sideImpulse){var d=u.raycastResult.body,L=new r;L.copy(u.raycastResult.hitPointWorld);var j=new r;l[c].scale(u.sideImpulse,j),a.pointToLocalFrame(q,q),q["xyz"[this.indexUpAxis]]*=u.rollInfluence,a.pointToWorldFrame(q,q),a.applyImpulse(j,q),j.scale(-1,j),d.applyImpulse(j,L)}}};var E=new r,x=new r,b=new r,R=new r,P=new r,T=new r,M=new r,S=new r,B=new r,z=new r},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,e){function i(t){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof t.coordinateSystem?new r(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new n(new r(5,2,.5));this.chassisBody=new o(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var o=t("./Body"),s=t("../shapes/Sphere"),n=t("../shapes/Box"),r=t("../math/Vec3"),a=t("../constraints/HingeConstraint");e.exports=i,i.prototype.addWheel=function(t){t=t||{};var e=t.body;e||(e=new o(1,new s(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0);var i=(new r,"undefined"!=typeof t.position?t.position.clone():new r),n=new r;this.chassisBody.pointToWorldFrame(i,n),e.position.set(n.x,n.y,n.z);var h="undefined"!=typeof t.axis?t.axis.clone():new r(0,1,0);this.wheelAxes.push(h);var l=new a(this.chassisBody,e,{pivotA:i,axisA:h,pivotB:r.ZERO,axisB:h,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},i.prototype.setSteeringValue=function(t,e){var i=this.wheelAxes[e],o=Math.cos(t),s=Math.sin(t),n=i.x,r=i.y;this.constraints[e].axisA.set(o*n-s*r,s*n+o*r,0);
},i.prototype.setMotorSpeed=function(t,e){var i=this.constraints[e];i.enableMotor(),i.motorTargetVelocity=t},i.prototype.disableMotor=function(t){var e=this.constraints[t];e.disableMotor()};var h=new r;i.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},i.prototype.applyWheelForce=function(t,e){var i=this.wheelAxes[e],o=this.wheelBodies[e],s=o.torque;i.scale(t,h),o.vectorToWorldFrame(h,h),s.vadd(h,s)},i.prototype.addToWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),o=0;o<i.length;o++)t.add(i[o]);for(var o=0;o<e.length;o++)t.addConstraint(e[o]);t.addEventListener("preStep",this._update.bind(this))},i.prototype._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},i.prototype.removeFromWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),o=0;o<i.length;o++)t.remove(i[o]);for(var o=0;o<e.length;o++)t.removeConstraint(e[o])};var l=new r;i.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],i=this.wheelBodies[t],o=i.angularVelocity;return this.chassisBody.vectorToWorldFrame(e,l),o.dot(l)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,e){function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.exports=i;var o=(t("../shapes/Shape"),t("../math/Vec3"));t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),i.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new o;i.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,o=t.id,n=this.smoothingRadius*this.smoothingRadius,r=s,a=0;a!==i;a++){var h=this.particles[a];h.position.vsub(t.position,r),o!==h.id&&r.norm2()<n&&e.push(h)}};var n=new o,r=new o,a=new o,h=new o,l=new o,p=new o;i.prototype.update=function(){for(var t=this.particles.length,e=n,i=this.speedOfSound,o=this.eps,s=0;s!==t;s++){var c=this.particles[s],u=this.neighbors[s];u.length=0,this.getNeighbors(c,u),u.push(this.particles[s]);for(var d=u.length,v=0,f=0;f!==d;f++){c.position.vsub(u[f].position,e);var m=e.norm(),y=this.w(m);v+=u[f].mass*y}this.densities[s]=v,this.pressures[s]=i*i*(this.densities[s]-this.density)}for(var w=r,g=a,E=h,x=l,b=p,s=0;s!==t;s++){var R=this.particles[s];w.set(0,0,0),g.set(0,0,0);for(var P,T,u=this.neighbors[s],d=u.length,f=0;f!==d;f++){var M=u[f];R.position.vsub(M.position,x);var S=x.norm();P=-M.mass*(this.pressures[s]/(this.densities[s]*this.densities[s]+o)+this.pressures[f]/(this.densities[f]*this.densities[f]+o)),this.gradw(x,E),E.mult(P,E),w.vadd(E,w),M.velocity.vsub(R.velocity,b),b.mult(1/(1e-4+this.densities[s]*this.densities[f])*this.viscosity*M.mass,b),T=this.nablaw(S),b.mult(T,b),g.vadd(b,g)}g.mult(R.mass,g),w.mult(R.mass,w),R.force.vadd(g,R.force),R.force.vadd(w,R.force)}},i.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},i.prototype.gradw=function(t,e){var i=t.norm(),o=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(o,9))*Math.pow(o*o-i*i,2),e)},i.prototype.nablaw=function(t){var e=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e);return i}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,e){function i(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new o,this.localAnchorB=new o,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var o=t("../math/Vec3");e.exports=i,i.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},i.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},i.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},i.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var s=new o,n=new o,r=new o,a=new o,h=new o,l=new o,p=new o,c=new o,u=new o,d=new o,v=new o;i.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,o=this.bodyA,f=this.bodyB,m=s,y=n,w=r,g=a,E=v,x=h,b=l,R=p,P=c,T=u,M=d;this.getWorldAnchorA(x),this.getWorldAnchorB(b),x.vsub(o.position,R),b.vsub(f.position,P),b.vsub(x,m);var S=m.norm();y.copy(m),y.normalize(),f.velocity.vsub(o.velocity,w),f.angularVelocity.cross(P,E),w.vadd(E,w),o.angularVelocity.cross(R,E),w.vsub(E,w),y.mult(-t*(S-i)-e*w.dot(y),g),o.force.vsub(g,o.force),f.force.vadd(g,f.force),R.cross(g,T),P.cross(g,M),o.torque.vsub(T,o.torque),f.torque.vadd(M,f.torque)}},{"../math/Vec3":30}],36:[function(t,e){function i(t){t=r.defaults(t,{chassisConnectionPointLocal:new o,chassisConnectionPointWorld:new o,directionLocal:new o,directionWorld:new o,axleLocal:new o,axleWorld:new o,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new n,this.worldTransform=new s,this.isInContact=!1}var o=t("../math/Vec3"),s=t("../math/Transform"),n=t("../collision/RaycastResult"),r=t("../utils/Utils");e.exports=i;var a=new o,h=new o,a=new o;i.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var i=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,h),t.getVelocityAtWorldPoint(h,a);var o=e.hitNormalWorld.dot(a);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var s=-1/i;this.suspensionRelativeVelocity=o*s,this.clippedInvContactDotSuspension=s}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,e){function i(t){o.call(this),this.type=o.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3"),n=t("./ConvexPolyhedron");i.prototype=new o,i.prototype.constructor=i,i.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,o=s,r=[new o((-t),(-e),(-i)),new o(t,(-e),(-i)),new o(t,e,(-i)),new o((-t),e,(-i)),new o((-t),(-e),i),new o(t,(-e),i),new o(t,e,i),new o((-t),e,i)],a=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],h=([new o(0,0,1),new o(0,1,0),new o(1,0,0)],new n(r,a));this.convexPolyhedronRepresentation=h,h.material=this.material},i.prototype.calculateLocalInertia=function(t,e){return e=e||new s,i.calculateInertia(this.halfExtents,t,e),e},i.calculateInertia=function(t,e,i){var o=t;i.x=1/12*e*(2*o.y*2*o.y+2*o.z*2*o.z),i.y=1/12*e*(2*o.x*2*o.x+2*o.z*2*o.z),i.z=1/12*e*(2*o.y*2*o.y+2*o.x*2*o.x)},i.prototype.getSideNormals=function(t,e){var i=t,o=this.halfExtents;if(i[0].set(o.x,0,0),i[1].set(0,o.y,0),i[2].set(0,0,o.z),i[3].set(-o.x,0,0),i[4].set(0,-o.y,0),i[5].set(0,0,-o.z),void 0!==e)for(var s=0;s!==i.length;s++)e.vmult(i[s],i[s]);return i},i.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var r=new s;new s,i.prototype.forEachWorldCorner=function(t,e,i){for(var o=this.halfExtents,s=[[o.x,o.y,o.z],[-o.x,o.y,o.z],[-o.x,-o.y,o.z],[-o.x,-o.y,-o.z],[o.x,-o.y,-o.z],[o.x,o.y,-o.z],[-o.x,o.y,-o.z],[o.x,-o.y,o.z]],n=0;n<s.length;n++)r.set(s[n][0],s[n][1],s[n][2]),e.vmult(r,r),t.vadd(r,r),i(r.x,r.y,r.z)};var a=[new s,new s,new s,new s,new s,new s,new s,new s];i.prototype.calculateWorldAABB=function(t,e,i,o){var s=this.halfExtents;a[0].set(s.x,s.y,s.z),a[1].set(-s.x,s.y,s.z),a[2].set(-s.x,-s.y,s.z),a[3].set(-s.x,-s.y,-s.z),a[4].set(s.x,-s.y,-s.z),a[5].set(s.x,s.y,-s.z),a[6].set(-s.x,s.y,-s.z),a[7].set(s.x,-s.y,s.z);var n=a[0];e.vmult(n,n),t.vadd(n,n),o.copy(n),i.copy(n);for(var r=1;8>r;r++){var n=a[r];e.vmult(n,n),t.vadd(n,n);var h=n.x,l=n.y,p=n.z;h>o.x&&(o.x=h),l>o.y&&(o.y=l),p>o.z&&(o.z=p),h<i.x&&(i.x=h),l<i.y&&(i.y=l),p<i.z&&(i.z=p)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,e){function i(t,e,i){o.call(this),this.type=o.types.CONVEXPOLYHEDRON,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3"),n=(t("../math/Quaternion"),t("../math/Transform"));i.prototype=new o,i.prototype.constructor=i;var r=new s;i.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,i=(e.length,this.uniqueEdges);i.length=0;for(var o=r,s=0;s!==t.length;s++)for(var n=t[s],a=n.length,h=0;h!==a;h++){var l=(h+1)%a;e[n[h]].vsub(e[n[l]],o),o.normalize();for(var p=!1,c=0;c!==i.length;c++)if(i[c].almostEquals(o)||i[c].almostEquals(o)){p=!0;break}p||i.push(o.clone())}},i.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var i=this.faceNormals[t]||new s;this.getFaceNormal(t,i),i.negate(i),this.faceNormals[t]=i;var o=this.vertices[this.faces[t][0]];if(i.dot(o)<0){console.error(".faceNormals["+t+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var e=0;e<this.faces[t].length;e++)console.warn(".vertices["+this.faces[t][e]+"] = Vec3("+this.vertices[this.faces[t][e]].toString()+")")}}};var a=new s,h=new s;i.computeNormal=function(t,e,i,o){e.vsub(t,h),i.vsub(e,a),a.cross(h,o),o.isZero()||o.normalize()},i.prototype.getFaceNormal=function(t,e){var o=this.faces[t],s=this.vertices[o[0]],n=this.vertices[o[1]],r=this.vertices[o[2]];return i.computeNormal(s,n,r,e)};var l=new s;i.prototype.clipAgainstHull=function(t,e,i,o,n,r,a,h,p){for(var c=l,u=-1,d=-Number.MAX_VALUE,v=0;v<i.faces.length;v++){c.copy(i.faceNormals[v]),n.vmult(c,c);var f=c.dot(r);f>d&&(d=f,u=v)}for(var m=[],y=i.faces[u],w=y.length,g=0;w>g;g++){var E=i.vertices[y[g]],x=new s;x.copy(E),n.vmult(x,x),o.vadd(x,x),m.push(x)}u>=0&&this.clipFaceAgainstHull(r,t,e,m,a,h,p)};var p=new s,c=new s,u=new s,d=new s,v=new s,f=new s;i.prototype.findSeparatingAxis=function(t,e,i,o,s,n,r,a){var h=p,l=c,m=u,y=d,w=v,g=f,E=Number.MAX_VALUE,x=this,b=0;if(x.uniqueAxes)for(var R=0;R!==x.uniqueAxes.length;R++){i.vmult(x.uniqueAxes[R],h);var P=x.testSepAxis(h,t,e,i,o,s);if(P===!1)return!1;E>P&&(E=P,n.copy(h))}else for(var T=r?r.length:x.faces.length,R=0;T>R;R++){var M=r?r[R]:R;h.copy(x.faceNormals[M]),i.vmult(h,h);var P=x.testSepAxis(h,t,e,i,o,s);if(P===!1)return!1;E>P&&(E=P,n.copy(h))}if(t.uniqueAxes)for(var R=0;R!==t.uniqueAxes.length;R++){s.vmult(t.uniqueAxes[R],l),b++;var P=x.testSepAxis(l,t,e,i,o,s);if(P===!1)return!1;E>P&&(E=P,n.copy(l))}else for(var S=a?a.length:t.faces.length,R=0;S>R;R++){var M=a?a[R]:R;l.copy(t.faceNormals[M]),s.vmult(l,l),b++;var P=x.testSepAxis(l,t,e,i,o,s);if(P===!1)return!1;E>P&&(E=P,n.copy(l))}for(var B=0;B!==x.uniqueEdges.length;B++){i.vmult(x.uniqueEdges[B],y);for(var z=0;z!==t.uniqueEdges.length;z++)if(s.vmult(t.uniqueEdges[z],w),y.cross(w,g),!g.almostZero()){g.normalize();var A=x.testSepAxis(g,t,e,i,o,s);if(A===!1)return!1;E>A&&(E=A,n.copy(g))}}return o.vsub(e,m),m.dot(n)>0&&n.negate(n),!0};var m=[],y=[];i.prototype.testSepAxis=function(t,e,o,s,n,r){var a=this;i.project(a,t,o,s,m),i.project(e,t,n,r,y);var h=m[0],l=m[1],p=y[0],c=y[1];if(c>h||l>p)return!1;var u=h-c,d=p-l,v=d>u?u:d;return v};var w=new s,g=new s;i.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(w,g);var i=g.x-w.x,o=g.y-w.y,s=g.z-w.z;e.x=1/12*t*(2*o*2*o+2*s*2*s),e.y=1/12*t*(2*i*2*i+2*s*2*s),e.z=1/12*t*(2*o*2*o+2*i*2*i)},i.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],i=this.faceNormals[t],o=this.vertices[e[0]],s=-i.dot(o);return s};var E=new s,x=new s,b=new s,R=new s,P=new s,T=new s,M=new s,S=new s;i.prototype.clipFaceAgainstHull=function(t,e,i,o,s,n,r){for(var a=E,h=x,l=b,p=R,c=P,u=T,d=M,v=S,f=this,m=[],y=o,w=m,g=-1,B=Number.MAX_VALUE,z=0;z<f.faces.length;z++){a.copy(f.faceNormals[z]),i.vmult(a,a);var A=a.dot(t);B>A&&(B=A,g=z)}if(!(0>g)){var C=f.faces[g];C.connectedFaces=[];for(var V=0;V<f.faces.length;V++)for(var F=0;F<f.faces[V].length;F++)-1!==C.indexOf(f.faces[V][F])&&V!==g&&-1===C.connectedFaces.indexOf(V)&&C.connectedFaces.push(V);for(var I=(y.length,C.length),q=0;I>q;q++){var H=f.vertices[C[q]],L=f.vertices[C[(q+1)%I]];H.vsub(L,h),l.copy(h),i.vmult(l,l),e.vadd(l,l),p.copy(this.faceNormals[g]),i.vmult(p,p),e.vadd(p,p),l.cross(p,c),c.negate(c),u.copy(H),i.vmult(u,u),e.vadd(u,u);var j,N=(-u.dot(c),C.connectedFaces[q]);d.copy(this.faceNormals[N]);var _=this.getPlaneConstantOfFace(N);v.copy(d),i.vmult(v,v);var j=_-v.dot(e);for(this.clipFaceAgainstPlane(y,w,v,j);y.length;)y.shift();for(;w.length;)y.push(w.shift())}d.copy(this.faceNormals[g]);var _=this.getPlaneConstantOfFace(g);v.copy(d),i.vmult(v,v);for(var j=_-v.dot(e),V=0;V<y.length;V++){var W=v.dot(y[V])+j;if(s>=W&&(console.log("clamped: depth="+W+" to minDist="+(s+"")),W=s),n>=W){var k=y[V];if(0>=W){var O={point:k,normal:v,depth:W};r.push(O)}}}}},i.prototype.clipFaceAgainstPlane=function(t,e,i,o){var n,r,a=t.length;if(2>a)return e;var h=t[t.length-1],l=t[0];n=i.dot(h)+o;for(var p=0;a>p;p++){if(l=t[p],r=i.dot(l)+o,0>n)if(0>r){var c=new s;c.copy(l),e.push(c)}else{var c=new s;h.lerp(l,n/(n-r),c),e.push(c)}else if(0>r){var c=new s;h.lerp(l,n/(n-r),c),e.push(c),e.push(l)}h=l,n=r}return e},i.prototype.computeWorldVertices=function(t,e){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new s);for(var o=this.vertices,n=this.worldVertices,r=0;r!==i;r++)e.vmult(o[r],n[r]),t.vadd(n[r],n[r]);this.worldVerticesNeedsUpdate=!1},new s,i.prototype.computeLocalAABB=function(t,e){var i=this.vertices.length,o=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;i>s;s++){var n=o[s];n.x<t.x?t.x=n.x:n.x>e.x&&(e.x=n.x),n.y<t.y?t.y=n.y:n.y>e.y&&(e.y=n.y),n.z<t.z?t.z=n.z:n.z>e.z&&(e.z=n.z)}},i.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new s);for(var i=this.faceNormals,o=this.worldFaceNormals,n=0;n!==e;n++)t.vmult(i[n],o[n]);this.worldFaceNormalsNeedsUpdate=!1},i.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,o=e.length;i!==o;i++){var s=e[i].norm2();s>t&&(t=s)}this.boundingSphereRadius=Math.sqrt(t)};var B=new s;i.prototype.calculateWorldAABB=function(t,e,i,o){for(var s,n,r,a,h,l,p=this.vertices.length,c=this.vertices,u=0;p>u;u++){B.copy(c[u]),e.vmult(B,B),t.vadd(B,B);var d=B;d.x<s||void 0===s?s=d.x:(d.x>a||void 0===a)&&(a=d.x),d.y<n||void 0===n?n=d.y:(d.y>h||void 0===h)&&(h=d.y),d.z<r||void 0===r?r=d.z:(d.z>l||void 0===l)&&(l=d.z)}i.set(s,n,r),o.set(a,h,l)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.prototype.getAveragePointLocal=function(t){t=t||new s;for(var e=this.vertices.length,i=this.vertices,o=0;e>o;o++)t.vadd(i[o],t);return t.mult(1/e,t),t},i.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,o=this.vertices;if(e){for(var s=0;i>s;s++){var n=o[s];e.vmult(n,n)}for(var s=0;s<this.faceNormals.length;s++){var n=this.faceNormals[s];e.vmult(n,n)}}if(t)for(var s=0;i>s;s++){var n=o[s];n.vadd(t,n)}};var z=new s,A=new s,C=new s;i.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,o=this.faces,s=this.faceNormals,n=null,r=this.faces.length,a=z;this.getAveragePointLocal(a);for(var h=0;r>h;h++){var e=(this.faces[h].length,s[h]),l=i[o[h][0]],p=A;t.vsub(l,p);var c=e.dot(p),u=C;a.vsub(l,u);var d=e.dot(u);if(0>c&&d>0||c>0&&0>d)return!1}return n?1:-1};var V=(new s,new s),F=new s;i.project=function(t,e,i,o,s){var r=t.vertices.length,a=V,h=0,l=0,p=F,c=t.vertices;p.setZero(),n.vectorToLocalFrame(i,o,e,a),n.pointToLocalFrame(i,o,p,p);var u=p.dot(a);l=h=c[0].dot(a);for(var d=1;r>d;d++){var v=c[d].dot(a);v>h&&(h=v),l>v&&(l=v)}if(l-=u,h-=u,l>h){var f=l;l=h,h=f}s[0]=h,s[1]=l}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,e){function i(t,e,i,r){var a=r,h=[],l=[],p=[],c=[],u=[],d=Math.cos,v=Math.sin;h.push(new s(e*d(0),e*v(0),.5*-i)),c.push(0),h.push(new s(t*d(0),t*v(0),.5*i)),u.push(1);for(var f=0;a>f;f++){var m=2*Math.PI/a*(f+1),y=2*Math.PI/a*(f+.5);a-1>f?(h.push(new s(e*d(m),e*v(m),.5*-i)),c.push(2*f+2),h.push(new s(t*d(m),t*v(m),.5*i)),u.push(2*f+3),p.push([2*f+2,2*f+3,2*f+1,2*f])):p.push([0,1,2*f+1,2*f]),(a%2===1||a/2>f)&&l.push(new s(d(y),v(y),0))}p.push(u),l.push(new s(0,0,1));for(var w=[],f=0;f<c.length;f++)w.push(c[c.length-f-1]);p.push(w),this.type=o.types.CONVEXPOLYHEDRON,n.call(this,h,p,l)}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3"),n=(t("../math/Quaternion"),t("./ConvexPolyhedron"));i.prototype=new n},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,e){function i(t,e){e=r.defaults(e,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=e.maxValue,this.minValue=e.minValue,this.elementSize=e.elementSize,null===e.minValue&&this.updateMinValue(),null===e.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,o.call(this),this.pillarConvex=new s,this.pillarOffset=new n,this.type=o.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var o=t("./Shape"),s=t("./ConvexPolyhedron"),n=t("../math/Vec3"),r=t("../utils/Utils");e.exports=i,i.prototype=new o,i.prototype.update=function(){this._cachedPillars={}},i.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var o=0;o!==t[i].length;o++){var s=t[i][o];e>s&&(e=s)}this.minValue=e},i.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var o=0;o!==t[i].length;o++){var s=t[i][o];s>e&&(e=s)}this.maxValue=e},i.prototype.setHeightValueAtIndex=function(t,e,i){var o=this.data;o[t][e]=i,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},i.prototype.getRectMinMax=function(t,e,i,o,s){s=s||[];for(var n=this.data,r=this.minValue,a=t;i>=a;a++)for(var h=e;o>=h;h++){var l=n[a][h];l>r&&(r=l)}s[0]=this.minValue,s[1]=r},i.prototype.getIndexOfPosition=function(t,e,i,o){var s=this.elementSize,n=this.data,r=Math.floor(t/s),a=Math.floor(e/s);return i[0]=r,i[1]=a,o&&(0>r&&(r=0),0>a&&(a=0),r>=n.length-1&&(r=n.length-1),a>=n[0].length-1&&(a=n[0].length-1)),!(0>r||0>a||r>=n.length-1||a>=n[0].length-1)},i.prototype.getHeightAt=function(t,e,i){var o=[];this.getIndexOfPosition(t,e,o,i);var s=[];return this.getRectMinMax(o[0],o[1]+1,o[0],o[1]+1,s),(s[0]+s[1])/2},i.prototype.getCacheConvexTrianglePillarKey=function(t,e,i){return t+"_"+e+"_"+(i?1:0)},i.prototype.getCachedConvexTrianglePillar=function(t,e,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.prototype.setCachedConvexTrianglePillar=function(t,e,i,o,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]={convex:o,offset:s}},i.prototype.clearCachedConvexTrianglePillar=function(t,e,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.prototype.getConvexTrianglePillar=function(t,e,i){var o=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){var a=this.getCachedConvexTrianglePillar(t,e,i);if(a)return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);o=new s,r=new n,this.pillarConvex=o,this.pillarOffset=r}var a=this.data,h=this.elementSize,l=o.faces;o.vertices.length=6;for(var p=0;6>p;p++)o.vertices[p]||(o.vertices[p]=new n);l.length=5;for(var p=0;5>p;p++)l[p]||(l[p]=[]);var c=o.vertices,u=(Math.min(a[t][e],a[t+1][e],a[t][e+1],a[t+1][e+1])-this.minValue)/2+this.minValue;i?(r.set((t+.75)*h,(e+.75)*h,u),c[0].set(.25*h,.25*h,a[t+1][e+1]-u),c[1].set(-.75*h,.25*h,a[t][e+1]-u),c[2].set(.25*h,-.75*h,a[t+1][e]-u),c[3].set(.25*h,.25*h,-u-1),c[4].set(-.75*h,.25*h,-u-1),c[5].set(.25*h,-.75*h,-u-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(r.set((t+.25)*h,(e+.25)*h,u),c[0].set(-.25*h,-.25*h,a[t][e]-u),c[1].set(.75*h,-.25*h,a[t+1][e]-u),c[2].set(-.25*h,.75*h,a[t][e+1]-u),c[3].set(-.25*h,-.25*h,-u-1),c[4].set(.75*h,-.25*h,-u-1),c[5].set(-.25*h,.75*h,-u-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,i,o,r)},i.prototype.calculateLocalInertia=function(t,e){return e=e||new n,e.set(0,0,0),e},i.prototype.volume=function(){return Number.MAX_VALUE},i.prototype.calculateWorldAABB=function(t,e,i,o){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new n(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,e){function i(){o.call(this),this.type=o.types.PARTICLE}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3");i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(t,e){return e=e||new s,e.set(0,0,0),e},i.prototype.volume=function(){return 0},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.prototype.calculateWorldAABB=function(t,e,i,o){i.copy(t),o.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,e){function i(){o.call(this),this.type=o.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3");i.prototype=new o,i.prototype.constructor=i,i.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(t,e){return e=e||new s},i.prototype.volume=function(){return Number.MAX_VALUE};var n=new s;i.prototype.calculateWorldAABB=function(t,e,i,o){n.set(0,0,1),e.vmult(n,n);var s=Number.MAX_VALUE;i.set(-s,-s,-s),o.set(s,s,s),1===n.x&&(o.x=t.x),1===n.y&&(o.y=t.y),1===n.z&&(o.z=t.z),-1===n.x&&(i.x=t.x),-1===n.y&&(i.y=t.y),-1===n.z&&(i.z=t.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,e){function i(){this.id=i.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}e.exports=i;var i=t("./Shape");t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,e){function i(t){if(o.call(this),this.radius=void 0!==t?Number(t):1,this.type=o.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3");i.prototype=new o,i.prototype.constructor=i,i.prototype.calculateLocalInertia=function(t,e){e=e||new s;var i=2*t*this.radius*this.radius/5;return e.x=i,e.y=i,e.z=i,e},i.prototype.volume=function(){return 4*Math.PI*this.radius/3},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.prototype.calculateWorldAABB=function(t,e,i,o){for(var s=this.radius,n=["x","y","z"],r=0;r<n.length;r++){var a=n[r];i[a]=t[a]-s,o[a]=t[a]+s}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,e){function i(t,e){o.call(this),this.type=o.types.TRIMESH,this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new r,this.edges=null,this.scale=new s(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}e.exports=i;var o=t("./Shape"),s=t("../math/Vec3"),n=(t("../math/Quaternion"),t("../math/Transform")),r=t("../collision/AABB"),a=t("../utils/Octree");i.prototype=new o,i.prototype.constructor=i;var h=new s;i.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var i=new r,o=new s,n=new s,a=new s,h=[o,n,a],l=0;l<this.indices.length/3;l++){var p=3*l;this._getUnscaledVertex(this.indices[p],o),this._getUnscaledVertex(this.indices[p+1],n),this._getUnscaledVertex(this.indices[p+2],a),i.setFromPoints(h),t.insert(i,l)}t.removeEmptyNodes()};var l=new r;i.prototype.getTrianglesInAABB=function(t,e){l.copy(t);var i=this.scale,o=i.x,s=i.y,n=i.z,r=l.lowerBound,a=l.upperBound;return r.x/=o,r.y/=s,r.z/=n,a.x/=o,a.y/=s,a.z/=n,this.tree.aabbQuery(l,e)},i.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,i=t.x===t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},i.prototype.updateNormals=function(){for(var t=h,e=this.normals,o=0;o<this.indices.length/3;o++){var s=3*o,n=this.indices[s],r=this.indices[s+1],a=this.indices[s+2];this.getVertex(n,v),this.getVertex(r,f),this.getVertex(a,m),i.computeNormal(f,v,m,t),e[s]=t.x,e[s+1]=t.y,e[s+2]=t.z}},i.prototype.updateEdges=function(){for(var t={},e=function(){var e=n>s?s+"_"+n:n+"_"+s;t[e]=!0},i=0;i<this.indices.length/3;i++){var o=3*i,s=this.indices[o],n=this.indices[o+1],r=this.indices[o+2];e(s,n),e(n,r),e(r,s)}var a=Object.keys(t);this.edges=new Int16Array(2*a.length);for(var i=0;i<a.length;i++){var h=a[i].split("_");this.edges[2*i]=parseInt(h[0],10),this.edges[2*i+1]=parseInt(h[1],10)}},i.prototype.getEdgeVertex=function(t,e,i){var o=this.edges[2*t+(e?1:0)];this.getVertex(o,i)};var p=new s,c=new s;i.prototype.getEdgeVector=function(t,e){var i=p,o=c;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,o),o.vsub(i,e)};var u=new s,d=new s;i.computeNormal=function(t,e,i,o){e.vsub(t,d),i.vsub(e,u),u.cross(d,o),o.isZero()||o.normalize()};var v=new s,f=new s,m=new s;i.prototype.getVertex=function(t,e){var i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e},i.prototype._getUnscaledVertex=function(t,e){var i=3*t,o=this.vertices;return e.set(o[i],o[i+1],o[i+2])},i.prototype.getWorldVertex=function(t,e,i,o){return this.getVertex(t,o),n.pointToWorldFrame(e,i,o,o),o},i.prototype.getTriangleVertices=function(t,e,i,o){var s=3*t;this.getVertex(this.indices[s],e),this.getVertex(this.indices[s+1],i),this.getVertex(this.indices[s+2],o)},i.prototype.getNormal=function(t,e){var i=3*t;return e.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var y=new r;i.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(y);var i=y.upperBound.x-y.lowerBound.x,o=y.upperBound.y-y.lowerBound.y,s=y.upperBound.z-y.lowerBound.z;return e.set(1/12*t*(2*o*2*o+2*s*2*s),1/12*t*(2*i*2*i+2*s*2*s),1/12*t*(2*o*2*o+2*i*2*i))};var w=new s;i.prototype.computeLocalAABB=function(t){var e=t.lowerBound,i=t.upperBound,o=this.vertices.length,s=(this.vertices,w);this.getVertex(0,s),e.copy(s),i.copy(s);for(var n=0;n!==o;n++)this.getVertex(n,s),s.x<e.x?e.x=s.x:s.x>i.x&&(i.x=s.x),s.y<e.y?e.y=s.y:s.y>i.y&&(i.y=s.y),s.z<e.z?e.z=s.z:s.z>i.z&&(i.z=s.z)},i.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},i.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=new s,o=0,n=e.length/3;o!==n;o++){this.getVertex(o,i);var r=i.norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)};var g=(new s,new n),E=new r;i.prototype.calculateWorldAABB=function(t,e,i,o){var s=g,n=E;s.position=t,s.quaternion=e,this.aabb.toWorldFrame(s,n),i.copy(n.lowerBound),o.copy(n.upperBound)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.createTorus=function(t,e,o,s,n){t=t||1,e=e||.5,o=o||8,s=s||6,n=n||2*Math.PI;for(var r=[],a=[],h=0;o>=h;h++)for(var l=0;s>=l;l++){var p=l/s*n,c=h/o*Math.PI*2,u=(t+e*Math.cos(c))*Math.cos(p),d=(t+e*Math.cos(c))*Math.sin(p),v=e*Math.sin(c);r.push(u,d,v)}for(var h=1;o>=h;h++)for(var l=1;s>=l;l++){var f=(s+1)*h+l-1,m=(s+1)*(h-1)+l-1,y=(s+1)*(h-1)+l,w=(s+1)*h+l;a.push(f,m,w),a.push(m,y,w)}return new i(r,a)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,e){function i(){o.call(this),this.iterations=10,this.tolerance=1e-7}e.exports=i;var o=(t("../math/Vec3"),t("../math/Quaternion"),t("./Solver"));i.prototype=new o;var s=[],n=[],r=[];i.prototype.solve=function(t,e){var i,o,a,h,l,p,c=0,u=this.iterations,d=this.tolerance*this.tolerance,v=this.equations,f=v.length,m=e.bodies,y=m.length,w=t;
if(0!==f)for(var g=0;g!==y;g++)m[g].updateSolveMassProperties();var E=n,x=r,b=s;E.length=f,x.length=f,b.length=f;for(var g=0;g!==f;g++){var R=v[g];b[g]=0,x[g]=R.computeB(w),E[g]=1/R.computeC()}if(0!==f){for(var g=0;g!==y;g++){var P=m[g],T=P.vlambda,M=P.wlambda;T.set(0,0,0),M&&M.set(0,0,0)}for(c=0;c!==u;c++){h=0;for(var S=0;S!==f;S++){var R=v[S];i=x[S],o=E[S],p=b[S],l=R.computeGWlambda(),a=o*(i-l-R.eps*p),p+a<R.minForce?a=R.minForce-p:p+a>R.maxForce&&(a=R.maxForce-p),b[S]+=a,h+=a>0?a:-a,R.addToWlambda(a)}if(d>h*h)break}for(var g=0;g!==y;g++){var P=m[g],B=P.velocity,z=P.angularVelocity;B.vadd(P.vlambda,B),z&&z.vadd(P.wlambda,z)}}return c}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,e){function i(){this.equations=[]}e.exports=i,i.prototype.solve=function(){return 0},i.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},i.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,e){function i(t){for(a.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function o(t){for(var e=t.length,i=0;i!==e;i++){var o=t[i];if(!(o.visited||o.body.type&u))return o}return!1}function s(t,e,i,s){for(d.push(t),t.visited=!0,e(t,i,s);d.length;)for(var n,r=d.pop();n=o(r.children);)n.visited=!0,e(n,i,s),d.push(n)}function n(t,e,i){e.push(t.body);for(var o=t.eqs.length,s=0;s!==o;s++){var n=t.eqs[s];-1===i.indexOf(n)&&i.push(n)}}function r(t,e){return e.id-t.id}e.exports=i;var a=(t("../math/Vec3"),t("../math/Quaternion"),t("./Solver")),h=t("../objects/Body");i.prototype=new a;var l=[],p=[],c={bodies:[]},u=h.STATIC,d=[];i.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.prototype.solve=function(t,e){for(var i=l,a=this.nodePool,h=e.bodies,u=this.equations,d=u.length,v=h.length,f=this.subsolver;a.length<v;)a.push(this.createNode());i.length=v;for(var m=0;v>m;m++)i[m]=a[m];for(var m=0;m!==v;m++){var y=i[m];y.body=h[m],y.children.length=0,y.eqs.length=0,y.visited=!1}for(var w=0;w!==d;w++){var g=u[w],m=h.indexOf(g.bi),E=h.indexOf(g.bj),x=i[m],b=i[E];x.children.push(b),x.eqs.push(g),b.children.push(x),b.eqs.push(g)}var R,P=0,T=p;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var M=c;R=o(i);){T.length=0,M.bodies.length=0,s(R,n,M.bodies,T);var S=T.length;T=T.sort(r);for(var m=0;m!==S;m++)f.addEquation(T[m]);f.solve(t,M),f.removeAllEquations(),P++}return P}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,e){var i=function(){};e.exports=i,i.prototype={constructor:i,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[t])return this;var o=i[t].indexOf(e);return-1!==o&&i[t].splice(o,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners,i=e[t.type];if(void 0!==i){t.target=this;for(var o=0,s=i.length;s>o;o++)i[o].call(this,t)}return this}}},{}],50:[function(t,e){function i(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new s,this.data=[],this.children=[]}function o(t,e){e=e||{},e.root=null,e.aabb=t,i.call(this,e),this.maxDepth="undefined"!=typeof e.maxDepth?e.maxDepth:8}var s=t("../collision/AABB"),n=t("../math/Vec3");e.exports=o,o.prototype=new i,i.prototype.reset=function(){this.children.length=this.data.length=0},i.prototype.insert=function(t,e,i){var o=this.data;if(i=i||0,!this.aabb.contains(t))return!1;var s=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var n=!1;s.length||(this.subdivide(),n=!0);for(var r=0;8!==r;r++)if(s[r].insert(t,e,i+1))return!0;n&&(s.length=0)}return o.push(e),!0};var r=new n;i.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,o=t.upperBound,a=this.children;a.push(new i({aabb:new s({lowerBound:new n(0,0,0)})}),new i({aabb:new s({lowerBound:new n(1,0,0)})}),new i({aabb:new s({lowerBound:new n(1,1,0)})}),new i({aabb:new s({lowerBound:new n(1,1,1)})}),new i({aabb:new s({lowerBound:new n(0,1,1)})}),new i({aabb:new s({lowerBound:new n(0,0,1)})}),new i({aabb:new s({lowerBound:new n(1,0,1)})}),new i({aabb:new s({lowerBound:new n(0,1,0)})})),o.vsub(e,r),r.scale(.5,r);for(var h=this.root||this,l=0;8!==l;l++){var p=a[l];p.root=h;var c=p.aabb.lowerBound;c.x*=r.x,c.y*=r.y,c.z*=r.z,c.vadd(e,c),c.vadd(r,p.aabb.upperBound)}},i.prototype.aabbQuery=function(t,e){for(var i=(this.data,this.children,[this]);i.length;){var o=i.pop();o.aabb.overlaps(t)&&Array.prototype.push.apply(e,o.data),Array.prototype.push.apply(i,o.children)}return e};var a=new s;i.prototype.rayQuery=function(t,e,i){return t.getAABB(a),a.toLocalFrame(e,a),this.aabbQuery(a,i),i},i.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var e=t.pop(),i=e.children.length-1;i>=0;i--)e.children[i].data.length||e.children.splice(i,1);Array.prototype.push.apply(t,e.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,e){function i(){this.objects=[],this.type=Object}e.exports=i,i.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,e){function i(){this.data={keys:[]}}e.exports=i,i.prototype.get=function(t,e){if(t>e){var i=e;e=t,t=i}return this.data[t+"-"+e]},i.prototype.set=function(t,e,i){if(t>e){var o=e;e=t,t=o}var s=t+"-"+e;this.get(t,e)||this.data.keys.push(s),this.data[s]=i},i.prototype.reset=function(){for(var t=this.data,e=t.keys;e.length>0;){var i=e.pop();delete t[i]}}},{}],53:[function(t,e){function i(){}e.exports=i,i.defaults=function(t,e){t=t||{};for(var i in e)i in t||(t[i]=e[i]);return t}},{}],54:[function(t,e){function i(){s.call(this),this.type=o}e.exports=i;var o=t("../math/Vec3"),s=t("./Pool");i.prototype=new s,i.prototype.constructObject=function(){return new o}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,e){function i(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new p,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function o(t,e,i){for(var o=null,s=t.length,n=0;n!==s;n++){var r=t[n],a=_;t[(n+1)%s].vsub(r,a);var h=W;a.cross(e,h);var l=k;i.vsub(r,l);var p=h.dot(l);if(!(null===o||p>0&&o===!0||0>=p&&o===!1))return!1;null===o&&(o=p>0)}return!0}e.exports=i;var s=t("../collision/AABB"),n=t("../shapes/Shape"),r=t("../collision/Ray"),a=t("../math/Vec3"),h=t("../math/Transform"),l=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),p=(t("../solver/Solver"),t("../utils/Vec3Pool")),c=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");i.prototype.createContactEquation=function(t,e,i,o,s,n){var r;this.contactPointPool.length?(r=this.contactPointPool.pop(),r.bi=t,r.bj=e):r=new c(t,e),r.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&o.collisionResponse;var a=this.currentContactMaterial;r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var h=i.material||t.material,l=o.material||e.material;return h&&l&&h.restitution>=0&&l.restitution>=0&&(r.restitution=h.restitution*l.restitution),r.si=s||i,r.sj=n||o,r},i.prototype.createFrictionEquationsFromContact=function(t,e){var i=t.bi,o=t.bj,s=t.si,n=t.sj,r=this.world,a=this.currentContactMaterial,h=a.friction,l=s.material||i.material,p=n.material||o.material;if(l&&p&&l.friction>=0&&p.friction>=0&&(h=l.friction*p.friction),h>0){var c=h*r.gravity.length(),d=i.invMass+o.invMass;d>0&&(d=1/d);var v=this.frictionEquationPool,f=v.length?v.pop():new u(i,o,c*d),m=v.length?v.pop():new u(i,o,c*d);return f.bi=m.bi=i,f.bj=m.bj=o,f.minForce=m.minForce=-c*d,f.maxForce=m.maxForce=c*d,f.ri.copy(t.ri),f.rj.copy(t.rj),m.ri.copy(t.ri),m.rj.copy(t.rj),t.ni.tangents(f.t,m.t),f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),m.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),f.enabled=m.enabled=t.enabled,e.push(f,m),!0}return!1};var d=new a,v=new a,f=new a;i.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var i=this.frictionResult[this.frictionResult.length-2],o=this.frictionResult[this.frictionResult.length-1];d.setZero(),v.setZero(),f.setZero();for(var s=e.bi,n=(e.bj,0);n!==t;n++)e=this.result[this.result.length-1-n],e.bodyA!==s?(d.vadd(e.ni,d),v.vadd(e.ri,v),f.vadd(e.rj,f)):(d.vsub(e.ni,d),v.vadd(e.rj,v),f.vadd(e.ri,f));var r=1/t;v.scale(r,i.ri),f.scale(r,i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj),d.normalize(),d.tangents(i.t,o.t)}};var m=new a,y=new a,w=new l,g=new l;i.prototype.getContacts=function(t,e,i,o,s,n,r){this.contactPointPool=s,this.frictionEquationPool=r,this.result=o,this.frictionResult=n;for(var a=w,h=g,l=m,p=y,c=0,u=t.length;c!==u;c++){var d=t[c],v=e[c],f=null;d.material&&v.material&&(f=i.getContactMaterial(d.material,v.material)||null);for(var E=0;E<d.shapes.length;E++){d.quaternion.mult(d.shapeOrientations[E],a),d.quaternion.vmult(d.shapeOffsets[E],l),l.vadd(d.position,l);for(var x=d.shapes[E],b=0;b<v.shapes.length;b++){v.quaternion.mult(v.shapeOrientations[b],h),v.quaternion.vmult(v.shapeOffsets[b],p),p.vadd(v.position,p);var R=v.shapes[b];if(!(l.distanceTo(p)>x.boundingSphereRadius+R.boundingSphereRadius)){var P=null;x.material&&R.material&&(P=i.getContactMaterial(x.material,R.material)||null),this.currentContactMaterial=P||f||i.defaultContactMaterial;var T=this[x.type|R.type];T&&(x.type<R.type?T.call(this,x,R,l,p,a,h,d,v,x,R):T.call(this,R,x,p,l,h,a,v,d,x,R))}}}}},i.prototype[n.types.BOX|n.types.BOX]=i.prototype.boxBox=function(t,e,i,o,s,n,r,a){t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,o,s,n,r,a,t,e)},i.prototype[n.types.BOX|n.types.CONVEXPOLYHEDRON]=i.prototype.boxConvex=function(t,e,i,o,s,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,o,s,n,r,a,t,e)},i.prototype[n.types.BOX|n.types.PARTICLE]=i.prototype.boxParticle=function(t,e,i,o,s,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,o,s,n,r,a,t,e)},i.prototype[n.types.SPHERE]=i.prototype.sphereSphere=function(t,e,i,o,s,n,r,a){var h=this.createContactEquation(r,a,t,e);o.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-e.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(r.position,h.ri),h.rj.vadd(o,h.rj),h.rj.vsub(a.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var E=new a,x=new a,b=new a;i.prototype[n.types.PLANE|n.types.TRIMESH]=i.prototype.planeTrimesh=function(t,e,i,o,s,n,r,l){var p=new a,c=E;c.set(0,0,1),s.vmult(c,c);for(var u=0;u<e.vertices.length/3;u++){e.getVertex(u,p);var d=new a;d.copy(p),h.pointToWorldFrame(o,n,d,p);var v=x;p.vsub(i,v);var f=c.dot(v);if(0>=f){var m=this.createContactEquation(r,l,t,e);m.ni.copy(c);var y=b;c.scale(v.dot(c),y),p.vsub(y,y),m.ri.copy(y),m.ri.vsub(r.position,m.ri),m.rj.copy(p),m.rj.vsub(l.position,m.rj),this.result.push(m),this.createFrictionEquationsFromContact(m,this.frictionResult)}}};var R=new a,P=new a,T=(new a,new a),M=new a,S=new a,B=new a,z=new a,A=new a,C=new a,V=new a,F=new a,I=new a,q=new a,H=new s,L=[];i.prototype[n.types.SPHERE|n.types.TRIMESH]=i.prototype.sphereTrimesh=function(t,e,i,o,s,n,a,l){var p=S,c=B,u=z,d=A,v=C,f=V,m=H,y=M,w=P,g=L;h.pointToLocalFrame(o,n,i,v);var E=t.radius;m.lowerBound.set(v.x-E,v.y-E,v.z-E),m.upperBound.set(v.x+E,v.y+E,v.z+E),e.getTrianglesInAABB(m,g);for(var x=T,b=t.radius*t.radius,j=0;j<g.length;j++)for(var N=0;3>N;N++)if(e.getVertex(e.indices[3*g[j]+N],x),x.vsub(v,w),w.norm2()<=b){y.copy(x),h.pointToWorldFrame(o,n,y,x),x.vsub(i,w);var _=this.createContactEquation(a,l,t,e);_.ni.copy(w),_.ni.normalize(),_.ri.copy(_.ni),_.ri.scale(t.radius,_.ri),_.ri.vadd(i,_.ri),_.ri.vsub(a.position,_.ri),_.rj.copy(x),_.rj.vsub(l.position,_.rj),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}for(var j=0;j<g.length;j++)for(var N=0;3>N;N++){e.getVertex(e.indices[3*g[j]+N],p),e.getVertex(e.indices[3*g[j]+(N+1)%3],c),c.vsub(p,u),v.vsub(c,f);var W=f.dot(u);v.vsub(p,f);var k=f.dot(u);if(k>0&&0>W){v.vsub(p,f),d.copy(u),d.normalize(),k=f.dot(d),d.scale(k,f),f.vadd(p,f);var O=f.distanceTo(v);if(O<t.radius){var _=this.createContactEquation(a,l,t,e);f.vsub(v,_.ni),_.ni.normalize(),_.ni.scale(t.radius,_.ri),h.pointToWorldFrame(o,n,f,f),f.vsub(l.position,_.rj),h.vectorToWorldFrame(n,_.ni,_.ni),h.vectorToWorldFrame(n,_.ri,_.ri),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}}}for(var D=F,Y=I,U=q,G=R,j=0,X=g.length;j!==X;j++){e.getTriangleVertices(g[j],D,Y,U),e.getNormal(g[j],G),v.vsub(D,f);var O=f.dot(G);if(G.scale(O,f),v.vsub(f,f),O=f.distanceTo(v),r.pointInTriangle(f,D,Y,U)&&O<t.radius){var _=this.createContactEquation(a,l,t,e);f.vsub(v,_.ni),_.ni.normalize(),_.ni.scale(t.radius,_.ri),h.pointToWorldFrame(o,n,f,f),f.vsub(l.position,_.rj),h.vectorToWorldFrame(n,_.ni,_.ni),h.vectorToWorldFrame(n,_.ri,_.ri),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}}g.length=0};var j=new a,N=new a;i.prototype[n.types.SPHERE|n.types.PLANE]=i.prototype.spherePlane=function(t,e,i,o,s,n,r,a){var h=this.createContactEquation(r,a,t,e);if(h.ni.set(0,0,1),n.vmult(h.ni,h.ni),h.ni.negate(h.ni),h.ni.normalize(),h.ni.mult(t.radius,h.ri),i.vsub(o,j),h.ni.mult(h.ni.dot(j),N),j.vsub(N,h.rj),-j.dot(h.ni)<=t.radius){var l=h.ri,p=h.rj;l.vadd(i,l),l.vsub(r.position,l),p.vadd(o,p),p.vsub(a.position,p),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var _=new a,W=new a,k=new a,O=new a,D=new a,Y=new a,U=new a,G=[new a,new a,new a,new a,new a,new a],X=new a,Q=new a,Z=new a,K=new a;i.prototype[n.types.SPHERE|n.types.BOX]=i.prototype.sphereBox=function(t,e,i,o,s,n,r,a){var h=this.v3pool,l=G;i.vsub(o,O),e.getSideNormals(l,n);for(var p=t.radius,c=!1,u=Q,d=Z,v=K,f=null,m=0,y=0,w=0,g=null,E=0,x=l.length;E!==x&&c===!1;E++){var b=D;b.copy(l[E]);var R=b.norm();b.normalize();var P=O.dot(b);if(R+p>P&&P>0){var T=Y,M=U;T.copy(l[(E+1)%3]),M.copy(l[(E+2)%3]);var S=T.norm(),B=M.norm();T.normalize(),M.normalize();var z=O.dot(T),A=O.dot(M);if(S>z&&z>-S&&B>A&&A>-B){var C=Math.abs(P-R-p);(null===g||g>C)&&(g=C,y=z,w=A,f=R,u.copy(b),d.copy(T),v.copy(M),m++)}}}if(m){c=!0;var V=this.createContactEquation(r,a,t,e);u.mult(-p,V.ri),V.ni.copy(u),V.ni.negate(V.ni),u.mult(f,u),d.mult(y,d),u.vadd(d,u),v.mult(w,v),u.vadd(v,V.rj),V.ri.vadd(i,V.ri),V.ri.vsub(r.position,V.ri),V.rj.vadd(o,V.rj),V.rj.vsub(a.position,V.rj),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult)}for(var F=h.get(),I=X,q=0;2!==q&&!c;q++)for(var H=0;2!==H&&!c;H++)for(var L=0;2!==L&&!c;L++)if(F.set(0,0,0),q?F.vadd(l[0],F):F.vsub(l[0],F),H?F.vadd(l[1],F):F.vsub(l[1],F),L?F.vadd(l[2],F):F.vsub(l[2],F),o.vadd(F,I),I.vsub(i,I),I.norm2()<p*p){c=!0;var V=this.createContactEquation(r,a,t,e);V.ri.copy(I),V.ri.normalize(),V.ni.copy(V.ri),V.ri.mult(p,V.ri),V.rj.copy(F),V.ri.vadd(i,V.ri),V.ri.vsub(r.position,V.ri),V.rj.vadd(o,V.rj),V.rj.vsub(a.position,V.rj),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult)}h.release(F),F=null;for(var j=h.get(),N=h.get(),V=h.get(),_=h.get(),C=h.get(),W=l.length,q=0;q!==W&&!c;q++)for(var H=0;H!==W&&!c;H++)if(q%3!==H%3){l[H].cross(l[q],j),j.normalize(),l[q].vadd(l[H],N),V.copy(i),V.vsub(N,V),V.vsub(o,V);var k=V.dot(j);j.mult(k,_);for(var L=0;L===q%3||L===H%3;)L++;C.copy(i),C.vsub(_,C),C.vsub(N,C),C.vsub(o,C);var J=Math.abs(k),$=C.norm();if(J<l[L].norm()&&p>$){c=!0;var tt=this.createContactEquation(r,a,t,e);N.vadd(_,tt.rj),tt.rj.copy(tt.rj),C.negate(tt.ni),tt.ni.normalize(),tt.ri.copy(tt.rj),tt.ri.vadd(o,tt.ri),tt.ri.vsub(i,tt.ri),tt.ri.normalize(),tt.ri.mult(p,tt.ri),tt.ri.vadd(i,tt.ri),tt.ri.vsub(r.position,tt.ri),tt.rj.vadd(o,tt.rj),tt.rj.vsub(a.position,tt.rj),this.result.push(tt),this.createFrictionEquationsFromContact(tt,this.frictionResult)}}h.release(j,N,V,_,C)};var J=new a,$=new a,tt=new a,et=new a,it=new a,ot=new a,st=new a,nt=new a,rt=new a,at=new a;i.prototype[n.types.SPHERE|n.types.CONVEXPOLYHEDRON]=i.prototype.sphereConvex=function(t,e,i,s,n,r,a,h){var l=this.v3pool;i.vsub(s,J);for(var p=e.faceNormals,c=e.faces,u=e.vertices,d=t.radius,v=0;v!==u.length;v++){var f=u[v],m=it;r.vmult(f,m),s.vadd(m,m);var y=et;if(m.vsub(i,y),y.norm2()<d*d){g=!0;var w=this.createContactEquation(a,h,t,e);return w.ri.copy(y),w.ri.normalize(),w.ni.copy(w.ri),w.ri.mult(d,w.ri),m.vsub(s,w.rj),w.ri.vadd(i,w.ri),w.ri.vsub(a.position,w.ri),w.rj.vadd(s,w.rj),w.rj.vsub(h.position,w.rj),this.result.push(w),void this.createFrictionEquationsFromContact(w,this.frictionResult)}}for(var g=!1,v=0,E=c.length;v!==E&&g===!1;v++){var x=p[v],b=c[v],R=ot;r.vmult(x,R);var P=st;r.vmult(u[b[0]],P),P.vadd(s,P);var T=nt;R.mult(-d,T),i.vadd(T,T);var M=rt;T.vsub(P,M);var S=M.dot(R),B=at;if(i.vsub(P,B),0>S&&B.dot(R)>0){for(var z=[],A=0,C=b.length;A!==C;A++){var V=l.get();r.vmult(u[b[A]],V),s.vadd(V,V),z.push(V)}if(o(z,R,i)){g=!0;var w=this.createContactEquation(a,h,t,e);R.mult(-d,w.ri),R.negate(w.ni);var F=l.get();R.mult(-S,F);var I=l.get();R.mult(-d,I),i.vsub(s,w.rj),w.rj.vadd(I,w.rj),w.rj.vadd(F,w.rj),w.rj.vadd(s,w.rj),w.rj.vsub(h.position,w.rj),w.ri.vadd(i,w.ri),w.ri.vsub(a.position,w.ri),l.release(F),l.release(I),this.result.push(w),this.createFrictionEquationsFromContact(w,this.frictionResult);for(var A=0,q=z.length;A!==q;A++)l.release(z[A]);return}for(var A=0;A!==b.length;A++){var H=l.get(),L=l.get();r.vmult(u[b[(A+1)%b.length]],H),r.vmult(u[b[(A+2)%b.length]],L),s.vadd(H,H),s.vadd(L,L);var j=$;L.vsub(H,j);var N=tt;j.unit(N);var _=l.get(),W=l.get();i.vsub(H,W);var k=W.dot(N);N.mult(k,_),_.vadd(H,_);var O=l.get();if(_.vsub(i,O),k>0&&k*k<j.norm2()&&O.norm2()<d*d){var w=this.createContactEquation(a,h,t,e);_.vsub(s,w.rj),_.vsub(i,w.ni),w.ni.normalize(),w.ni.mult(d,w.ri),w.rj.vadd(s,w.rj),w.rj.vsub(h.position,w.rj),w.ri.vadd(i,w.ri),w.ri.vsub(a.position,w.ri),this.result.push(w),this.createFrictionEquationsFromContact(w,this.frictionResult);for(var A=0,q=z.length;A!==q;A++)l.release(z[A]);return l.release(H),l.release(L),l.release(_),l.release(O),void l.release(W)}l.release(H),l.release(L),l.release(_),l.release(O),l.release(W)}for(var A=0,q=z.length;A!==q;A++)l.release(z[A])}}},new a,new a,i.prototype[n.types.PLANE|n.types.BOX]=i.prototype.planeBox=function(t,e,i,o,s,n,r,a){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.planeConvex(t,e.convexPolyhedronRepresentation,i,o,s,n,r,a)};var ht=new a,lt=new a,pt=new a,ct=new a;i.prototype[n.types.PLANE|n.types.CONVEXPOLYHEDRON]=i.prototype.planeConvex=function(t,e,i,o,s,n,r,a){var h=ht,l=lt;l.set(0,0,1),s.vmult(l,l);for(var p=0,c=pt,u=0;u!==e.vertices.length;u++){h.copy(e.vertices[u]),n.vmult(h,h),o.vadd(h,h),h.vsub(i,c);var d=l.dot(c);if(0>=d){var v=this.createContactEquation(r,a,t,e),f=ct;l.mult(l.dot(c),f),h.vsub(f,f),f.vsub(i,v.ri),v.ni.copy(l),h.vsub(o,v.rj),v.ri.vadd(i,v.ri),v.ri.vsub(r.position,v.ri),v.rj.vadd(o,v.rj),v.rj.vsub(a.position,v.rj),this.result.push(v),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var ut=new a,dt=new a;i.prototype[n.types.CONVEXPOLYHEDRON]=i.prototype.convexConvex=function(t,e,i,o,s,n,r,a,h,l,p,c){var u=ut;if(!(i.distanceTo(o)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,s,o,n,u,p,c)){var d=[],v=dt;t.clipAgainstHull(i,s,e,o,n,u,-100,100,d);for(var f=0,m=0;m!==d.length;m++){var y=this.createContactEquation(r,a,t,e,h,l),w=y.ri,g=y.rj;u.negate(y.ni),d[m].normal.negate(v),v.mult(d[m].depth,v),d[m].point.vadd(v,w),g.copy(d[m].point),w.vsub(i,w),g.vsub(o,g),w.vadd(i,w),w.vsub(r.position,w),g.vadd(o,g),g.vsub(a.position,g),this.result.push(y),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var vt=new a,ft=new a,mt=new a;i.prototype[n.types.PLANE|n.types.PARTICLE]=i.prototype.planeParticle=function(t,e,i,o,s,n,r,a){var h=vt;h.set(0,0,1),r.quaternion.vmult(h,h);var l=ft;o.vsub(r.position,l);var p=h.dot(l);if(0>=p){var c=this.createContactEquation(a,r,e,t);c.ni.copy(h),c.ni.negate(c.ni),c.ri.set(0,0,0);var u=mt;h.mult(h.dot(o),u),o.vsub(u,u),c.rj.copy(u),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var yt=new a;i.prototype[n.types.PARTICLE|n.types.SPHERE]=i.prototype.sphereParticle=function(t,e,i,o,s,n,r,a){var h=yt;h.set(0,0,1),o.vsub(i,h);var l=h.norm2();if(l<=t.radius*t.radius){var p=this.createContactEquation(a,r,e,t);h.normalize(),p.rj.copy(h),p.rj.mult(t.radius,p.rj),p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var wt=new l,gt=new a,Et=(new a,new a),xt=new a,bt=new a;i.prototype[n.types.PARTICLE|n.types.CONVEXPOLYHEDRON]=i.prototype.convexParticle=function(t,e,i,o,s,n,r,a){var h=-1,l=Et,p=bt,c=null,u=0,d=gt;if(d.copy(o),d.vsub(i,d),s.conjugate(wt),wt.vmult(d,d),t.pointIsInside(d)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,s),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(s);for(var v=0,f=t.faces.length;v!==f;v++){var m=[t.worldVertices[t.faces[v][0]]],y=t.worldFaceNormals[v];o.vsub(m[0],xt);var w=-y.dot(xt);(null===c||Math.abs(w)<Math.abs(c))&&(c=w,h=v,l.copy(y),u++)}if(-1!==h){var g=this.createContactEquation(a,r,e,t);l.mult(c,p),p.vadd(o,p),p.vsub(i,p),g.rj.copy(p),l.negate(g.ni),g.ri.set(0,0,0);var E=g.ri,x=g.rj;E.vadd(o,E),E.vsub(a.position,E),x.vadd(i,x),x.vsub(r.position,x),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},i.prototype[n.types.BOX|n.types.HEIGHTFIELD]=i.prototype.boxHeightfield=function(t,e,i,o,s,n,r,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,o,s,n,r,a)};var Rt=new a,Pt=new a,Tt=[0];i.prototype[n.types.CONVEXPOLYHEDRON|n.types.HEIGHTFIELD]=i.prototype.convexHeightfield=function(t,e,i,o,s,n,r,a){var l=e.data,p=e.elementSize,c=t.boundingSphereRadius,u=Pt,d=Tt,v=Rt;h.pointToLocalFrame(o,n,i,v);var f=Math.floor((v.x-c)/p)-1,m=Math.ceil((v.x+c)/p)+1,y=Math.floor((v.y-c)/p)-1,w=Math.ceil((v.y+c)/p)+1;if(!(0>m||0>w||f>l.length||y>l[0].length)){0>f&&(f=0),0>m&&(m=0),0>y&&(y=0),0>w&&(w=0),f>=l.length&&(f=l.length-1),m>=l.length&&(m=l.length-1),w>=l[0].length&&(w=l[0].length-1),y>=l[0].length&&(y=l[0].length-1);var g=[];e.getRectMinMax(f,y,m,w,g);var E=g[0],x=g[1];if(!(v.z-c>x||v.z+c<E))for(var b=f;m>b;b++)for(var R=y;w>R;R++)e.getConvexTrianglePillar(b,R,!1),h.pointToWorldFrame(o,n,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,u,s,n,r,a,null,null,d,null),e.getConvexTrianglePillar(b,R,!0),h.pointToWorldFrame(o,n,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,u,s,n,r,a,null,null,d,null)}};var Mt=new a,St=new a;i.prototype[n.types.SPHERE|n.types.HEIGHTFIELD]=i.prototype.sphereHeightfield=function(t,e,i,o,s,n,r,a){var l=e.data,p=t.radius,c=e.elementSize,u=St,d=Mt;h.pointToLocalFrame(o,n,i,d);var v=Math.floor((d.x-p)/c)-1,f=Math.ceil((d.x+p)/c)+1,m=Math.floor((d.y-p)/c)-1,y=Math.ceil((d.y+p)/c)+1;if(!(0>f||0>y||v>l.length||y>l[0].length)){0>v&&(v=0),0>f&&(f=0),0>m&&(m=0),0>y&&(y=0),v>=l.length&&(v=l.length-1),f>=l.length&&(f=l.length-1),y>=l[0].length&&(y=l[0].length-1),m>=l[0].length&&(m=l[0].length-1);var w=[];e.getRectMinMax(v,m,f,y,w);var g=w[0],E=w[1];if(!(d.z-p>E||d.z+p<g))for(var x=this.result,b=v;f>b;b++)for(var R=m;y>R;R++){var P=x.length;e.getConvexTrianglePillar(b,R,!1),h.pointToWorldFrame(o,n,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,u,s,n,r,a),e.getConvexTrianglePillar(b,R,!0),h.pointToWorldFrame(o,n,e.pillarOffset,u),i.distanceTo(u)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,u,s,n,r,a);var T=x.length-P;if(T>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,e){function i(){h.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new y,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new a(this),this.collisionMatrix=new l,this.collisionMatrixPrevious=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new d,this.defaultMaterial=new p("default"),this.defaultContactMaterial=new c(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}e.exports=i;var o=t("../shapes/Shape"),s=t("../math/Vec3"),n=t("../math/Quaternion"),r=t("../solver/GSSolver"),a=(t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),h=t("../utils/EventTarget"),l=t("../collision/ArrayCollisionMatrix"),p=t("../material/Material"),c=t("../material/ContactMaterial"),u=t("../objects/Body"),d=t("../utils/TupleDictionary"),v=t("../collision/RaycastResult"),f=t("../collision/AABB"),m=t("../collision/Ray"),y=t("../collision/NaiveBroadphase");i.prototype=new h;var w=(new f,new m);if(i.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},i.prototype.numObjects=function(){return this.bodies.length},i.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset()},i.prototype.add=i.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof u&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.dispatchEvent(this.addBodyEvent))},i.prototype.addConstraint=function(t){this.constraints.push(t)},i.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},i.prototype.rayTest=function(t,e,i){i instanceof v?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)},i.prototype.raycastAll=function(t,e,i,o){return i.mode=m.ALL,i.from=t,i.to=e,i.callback=o,w.intersectWorld(this,i)},i.prototype.raycastAny=function(t,e,i,o){return i.mode=m.ANY,i.from=t,i.to=e,i.result=o,w.intersectWorld(this,i)},i.prototype.raycastClosest=function(t,e,i,o){return i.mode=m.CLOSEST,i.from=t,i.to=e,i.result=o,w.intersectWorld(this,i)},i.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,o=i.indexOf(t);if(-1!==o){i.splice(o,1);for(var s=0;s!==i.length;s++)i[s].index=s;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,this.dispatchEvent(this.removeBodyEvent)}},i.prototype.removeBody=i.prototype.remove,i.prototype.addMaterial=function(t){this.materials.push(t)},i.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var g=Date.now();performance.timing&&performance.timing.navigationStart&&(g=performance.timing.navigationStart),performance.now=function(){return Date.now()-g}}var E=new s;i.prototype.step=function(t,e,i){if(i=i||10,e=e||0,0===e)this.internalStep(t),this.time+=t;else{var o=Math.floor((this.time+e)/t)-Math.floor(this.time/t);o=Math.min(o,i);for(var s=performance.now(),n=0;n!==o&&(this.internalStep(t),!(performance.now()-s>1e3*t));n++);this.time+=e;for(var r=this.time%t,a=r/t,h=E,l=this.bodies,p=0;p!==l.length;p++){var c=l[p];c.type!==u.STATIC&&c.sleepState!==u.SLEEPING?(c.position.vsub(c.previousPosition,h),h.scale(a,h),c.position.vadd(h,c.interpolatedPosition)):(c.interpolatedPosition.copy(c.position),c.interpolatedQuaternion.copy(c.quaternion))}}};var x={type:"postStep"},b={type:"preStep"},R={type:"collide",body:null,contact:null},P=[],T=[],M=[],S=[],B=(new s,new s,new s,new s,new s,new s,new s,new s,new s,new n,new n),z=new n,A=new s;i.prototype.internalStep=function(t){this.dt=t;var e,i=this.contacts,s=M,n=S,r=this.numObjects(),a=this.bodies,h=this.solver,l=this.gravity,p=this.doProfiling,c=this.profile,d=u.DYNAMIC,v=this.constraints,f=T,m=(l.norm(),l.x),y=l.y,w=l.z,g=0;for(p&&(e=performance.now()),g=0;g!==r;g++){var E=a[g];if(E.type&d){var C=E.force,V=E.mass;C.x+=V*m,C.y+=V*y,C.z+=V*w}}for(var g=0,F=this.subsystems.length;g!==F;g++)this.subsystems[g].update();p&&(e=performance.now()),s.length=0,n.length=0,this.broadphase.collisionPairs(this,s,n),p&&(c.broadphase=performance.now()-e);var I=v.length;for(g=0;g!==I;g++){var q=v[g];if(!q.collideConnected)for(var H=s.length-1;H>=0;H-=1)(q.bodyA===s[H]&&q.bodyB===n[H]||q.bodyB===s[H]&&q.bodyA===n[H])&&(s.splice(H,1),n.splice(H,1))}this.collisionMatrixTick(),p&&(e=performance.now());var L=P,j=i.length;for(g=0;g!==j;g++)L.push(i[g]);i.length=0;var N=this.frictionEquations.length;for(g=0;g!==N;g++)f.push(this.frictionEquations[g]);this.frictionEquations.length=0,this.narrowphase.getContacts(s,n,this,i,L,this.frictionEquations,f),p&&(c.narrowphase=performance.now()-e),p&&(e=performance.now());for(var g=0;g<this.frictionEquations.length;g++)h.addEquation(this.frictionEquations[g]);for(var _=i.length,W=0;W!==_;W++){var k,q=i[W],E=q.bi,O=q.bj;q.si,q.sj,k=E.material&&O.material?this.getContactMaterial(E.material,O.material)||this.defaultContactMaterial:this.defaultContactMaterial;var D=k.friction;if(E.material&&O.material&&(E.material.friction>=0&&O.material.friction>=0&&(D=E.material.friction*O.material.friction),E.material.restitution>=0&&O.material.restitution>=0&&(q.restitution=E.material.restitution*O.material.restitution)),h.addEquation(q),E.allowSleep&&E.type===u.DYNAMIC&&E.sleepState===u.SLEEPING&&O.sleepState===u.AWAKE&&O.type!==u.STATIC){
var Y=O.velocity.norm2()+O.angularVelocity.norm2(),U=Math.pow(O.sleepSpeedLimit,2);Y>=2*U&&(E._wakeUpAfterNarrowphase=!0)}if(O.allowSleep&&O.type===u.DYNAMIC&&O.sleepState===u.SLEEPING&&E.sleepState===u.AWAKE&&E.type!==u.STATIC){var G=E.velocity.norm2()+E.angularVelocity.norm2(),X=Math.pow(E.sleepSpeedLimit,2);G>=2*X&&(O._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(E,O,!0),this.collisionMatrixPrevious.get(E,O)||(R.body=O,R.contact=q,E.dispatchEvent(R),R.body=E,O.dispatchEvent(R))}for(p&&(c.makeContactConstraints=performance.now()-e,e=performance.now()),g=0;g!==r;g++){var E=a[g];E._wakeUpAfterNarrowphase&&(E.wakeUp(),E._wakeUpAfterNarrowphase=!1)}var I=v.length;for(g=0;g!==I;g++){var q=v[g];q.update();for(var H=0,Q=q.equations.length;H!==Q;H++){var Z=q.equations[H];h.addEquation(Z)}}h.solve(t,this),p&&(c.solve=performance.now()-e),h.removeAllEquations();var K=Math.pow;for(g=0;g!==r;g++){var E=a[g];if(E.type&d){var J=K(1-E.linearDamping,t),$=E.velocity;$.mult(J,$);var tt=E.angularVelocity;if(tt){var et=K(1-E.angularDamping,t);tt.mult(et,tt)}}}for(this.dispatchEvent(b),g=0;g!==r;g++){var E=a[g];E.preStep&&E.preStep.call(E)}p&&(e=performance.now());var it=B,ot=z,st=this.stepnumber,nt=u.DYNAMIC|u.KINEMATIC,rt=st%(this.quatNormalizeSkip+1)===0,at=this.quatNormalizeFast,ht=.5*t;for(o.types.PLANE,o.types.CONVEXPOLYHEDRON,g=0;g!==r;g++){var lt=a[g],pt=lt.force,ct=lt.torque;if(lt.type&nt&&lt.sleepState!==u.SLEEPING){var ut=lt.velocity,dt=lt.angularVelocity,vt=lt.position,ft=lt.quaternion,mt=lt.invMass,yt=lt.invInertiaWorld;ut.x+=pt.x*mt*t,ut.y+=pt.y*mt*t,ut.z+=pt.z*mt*t,lt.angularVelocity&&(yt.vmult(ct,A),A.mult(t,A),A.vadd(dt,dt)),vt.x+=ut.x*t,vt.y+=ut.y*t,vt.z+=ut.z*t,lt.angularVelocity&&(it.set(dt.x,dt.y,dt.z,0),it.mult(ft,ot),ft.x+=ht*ot.x,ft.y+=ht*ot.y,ft.z+=ht*ot.z,ft.w+=ht*ot.w,rt&&(at?ft.normalizeFast():ft.normalize())),lt.aabb&&(lt.aabbNeedsUpdate=!0),lt.updateInertiaWorld&&lt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,p&&(c.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(x),g=0;g!==r;g++){var E=a[g],wt=E.postStep;wt&&wt.call(E)}if(this.allowSleep)for(g=0;g!==r;g++)a[g].sleepTick(this.time)},i.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var o=t[i];o.force,o.torque,o.force.set(0,0,0),o.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});var PointerLockControls=function(t,e,i){var o=.2,s=20,n=.9,r=this,a=new THREE.Object3D;a.add(t);var h=new THREE.Object3D;h.position.y=3,h.rotation.y=Math.PI,h.add(a);var l=new THREE.Quaternion,p=!1,c=!1,u=!1,d=!1,v=!1,f=new CANNON.Vec3,m=new CANNON.Vec3(0,1,0);e.addEventListener("collide",function(t){var i=t.contact;i.bi.id==e.id?i.ni.negate(f):f.copy(i.ni),f.dot(m)>.5&&(v=!0)});var y=e.velocity,w=Math.PI/2,g=function(t){if(r.enabled!==!1){var e=t.movementX||t.mozMovementX||t.webkitMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||0;h.rotation.y-=.002*e,a.rotation.x-=.002*i,a.rotation.x=Math.max(-w,Math.min(w,a.rotation.x))}},E=function(t){switch(t.keyCode){case 38:case 87:p=!0;break;case 37:case 65:u=!0;break;case 40:case 83:c=!0;break;case 39:case 68:d=!0;break;case 32:v===!0&&(y.y=s),v=!1}},x=function(t){switch(t.keyCode){case 38:case 87:p=!1;break;case 37:case 65:u=!1;break;case 40:case 83:c=!1;break;case 39:case 68:d=!1}};document.addEventListener("mousemove",g,!1),document.addEventListener("keydown",E,!1),document.addEventListener("keyup",x,!1),this.enabled=!1,this.getObject=function(){return h},this.getDirection=function(t){t.set(0,0,-1),l.multiplyVector3(t)};var b=new THREE.Vector3,R=new THREE.Euler;this.update=function(t){r.enabled!==!1&&(t*=.1,b.set(0,0,0),p&&(b.z=-o*t),c&&(b.z=o*t),u&&(b.x=-o*t),d&&(b.x=o*t),R.x=a.rotation.x,R.y=h.rotation.y,R.order="XYZ",l.setFromEuler(R),b.applyQuaternion(l),y.x+=b.x,y.z+=b.z,d||u||p||c||0===y.y||(y.x=y.x*n,y.z=y.z*n),i.record(y.x+2*b.x,y.y,y.z+2*b.z),h.position.copy(e.position))}},FPP=FPP||{};FPP.LCS=function(t,e,i){var o=new function(){this.camera=new THREE.PerspectiveCamera(75,t.innerWidth/t.innerHeight,.1,1e4),this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer};return o.initLights=function(){var t=new THREE.AmbientLight(16777215,.7);o.scene.add(t)},o.initRenderer=function(){o.renderer.shadowMap.enabled=!0,o.renderer.shadowMapSoft=!0,o.renderer.setSize(t.innerWidth,t.innerHeight)},o.init=function(){o.initLights(),o.initRenderer(),e.body.appendChild(o.renderer.domElement),t.addEventListener("resize",o.onWindowResize,!1)},o.onWindowResize=function(){o.camera.aspect=t.innerWidth/t.innerHeight,o.camera.updateProjectionMatrix(),o.renderer.setSize(t.innerWidth,t.innerHeight)},o}(window,document),FPP.GEOMETRY=function(t,e,i){function o(t,e,i,o){var n=t.translate;if(e.stretch!==!0){var r=e.wrap_w||1,a=e.wrap_h||1;o.wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.anisotropy=16,o.magFilter=THREE.LinearFilter,o.repeat.set(r,a)}var h={default:THREE.FrontSide,b:THREE.BackSide,d:THREE.DoubleSide},l=new THREE.MeshPhongMaterial({map:o,side:h[e.side]||THREE.FrontSide}),p=new THREE.Mesh(i,l);p.castShadow=!0,p.receiveShadow=!0,p.position.set(n.x,n.y,n.z),FPP.LCS.scene.add(p),t.id&&(p.name=t.id,p.originalY=p.position.y,p.raise=t.height,s.doorMeshes.push(p)),t.gifId&&(p.material.transparent=!0,s.gifs[t.gifId]=p)}var s=new function(){this.loader=new THREE.TextureLoader,this.world=new CANNON.World,this.solver=new CANNON.GSSolver,this.solver.iterations=5,this.solver.tolerance=.1,this.buttonMeshes=[],this.doorMeshes=[],this.doorBodies=[],this.gifs={},this.sBtnCount=0,this.timingEvents={},this.imageCache={},this.loadedImgCount=0,this.group=function(t){return Math.pow(2,t-1)};var t=!0;this.world.solver=t?new CANNON.SplitSolver(this.solver):this.solver},n=function(){if(s.loadedImgCount--,0===s.loadedImgCount){var t=e.querySelector(".loading"),i=e.querySelector(".spinner");i.classList.toggle("hide",!0),t.classList.toggle("fadeout",!0)}};return s.makeTunnel=function(t,e,i,o,s){var n=new THREE.CylinderGeometry(t,e,i,4,64,(!0)),r=new THREE.MeshPhongMaterial({transparent:!0,wireframe:!1,opacity:.5,side:THREE.DoubleSide}),a=new THREE.Mesh(n,r);a.position.copy(o),a.rotateX(s.x),a.rotateY(s.y),a.rotateZ(s.z),FPP.LCS.scene.add(a);var h=new THREE.EdgesHelper(a,7171437);FPP.LCS.scene.add(h)},s.physicsTile=function(t,e,i,o,n){var r=new CANNON.Body({mass:0}),a=.5*e,h=.5*i,l=[-a,0,-h,a,0,-h,-a,0,h,a,0,h],p=new CANNON.Trimesh(l,[0,1,2]),c=new CANNON.Trimesh(l,[1,3,2]);r.addShape(p),r.addShape(c),r.collisionFilterMask=this.group(1)|this.group(2)|this.group(3),o&&r.quaternion.copy(o),r.position.set(t.x,t.y,t.z),s.world.addBody(r),n&&(r.name=n,s.doorBodies.push(r))},s.makeTile=function(t,e){var i=.5*t.width,r=.5*t.height,a=new THREE.Geometry;a.vertices=[new THREE.Vector3(i,0,r),new THREE.Vector3(i,0,(-r)),new THREE.Vector3((-i),0,(-r)),new THREE.Vector3((-i),0,r)],a.faces=[new THREE.Face3(1,2,3),new THREE.Face3(0,1,3)],a.computeFaceNormals(),a.computeVertexNormals();var h=[new THREE.Vector2(1,0),new THREE.Vector2(0,0),new THREE.Vector2(0,1)],l=[new THREE.Vector2(1,1),new THREE.Vector2(1,0),new THREE.Vector2(0,1)];a.faceVertexUvs[0].push(h,l),a.uvsNeedUpdate=!0,a.buffersNeedUpdate=!0;var p=(new THREE.Quaternion).setFromEuler(new THREE.Euler(t.rx,t.ry,t.rz,"XZY"));a.applyMatrix((new THREE.Matrix4).makeRotationFromQuaternion(p));var c=t.translate;if(e.solid&&s.physicsTile(c,t.width,t.height,p,t.id),t.mat){var u=new THREE.Mesh(a,t.mat);u.castShadow=!0,u.receiveShadow=!0,u.position.set(c.x,c.y,c.z),FPP.LCS.scene.add(u)}else if(s.loadedImgCount++,s.imageCache[t.image_path])if(s.imageCache[t.image_path].img){n(),console.log("used cache!");var d=s.imageCache[t.image_path].img.clone();o(t,e,a,d)}else{var v={s:t,o:e,g:a};s.imageCache[t.image_path].todo.push(v)}else s.imageCache[t.image_path]={img:!1,todo:[]},s.loader.load(t.image_path,function(i){s.imageCache[t.image_path].img=i,n(),o(t,e,a,i);for(var r=s.imageCache[t.image_path].todo,h=0,l=r.length;h<l;h++){n();var p=i.clone();p.needsUpdate=!0,o(r[h].s,r[h].o,r[h].g,p),console.log("used cache")}},function(t){},function(t){console.log(t,"Texture Load Error Occurred")})},s.updateDoors=function(t,e){for(var i=s.doorMeshes,o=0,n=i.length;o<n;o++)if(i[o].name&&i[o].name===t){var r=i[o];e?(clearInterval(s.timingEvents[String(t)]),s.timingEvents[String(t)]=setInterval(function(){r.position.y>=r.originalY+r.raise?(r.position.y=r.originalY+r.raise,clearInterval(s.timingEvents[String(t)])):r.position.y+=.1,s.doorBodies.filter(function(e){e.name===t&&e.position.copy(r.position)})},15)):(clearInterval(s.timingEvents[String(t)]),s.timingEvents[String(t)]=setInterval(function(){r.position.y<r.originalY?(r.position.y=r.originalY,clearInterval(s.timingEvents[String(t)])):r.position.y-=.1,s.doorBodies.filter(function(e){e.name===t&&e.position.copy(r.position)})},15))}},s.updateButtons=function(){for(var t=s.buttonMeshes,e=3,i=0,o=t.length;i<o;i++){var n=t[i].position,r=FPP.PLAYER.firstPerson.position,a=FPP.PLAYER.p2.position,h=Math.sqrt((n.x-r.x)*(n.x-r.x)+(n.y-r.y)*(n.y-r.y)+(n.z-r.z)*(n.z-r.z)),l=Math.sqrt((n.x-a.x)*(n.x-a.x)+(n.y-a.y)*(n.y-a.y)+(n.z-a.z)*(n.z-a.z));if(h<e||l<e)0!==t[i].material.color.r&&(t[i].material.color=new THREE.Color("#009500"),t[i].material.needsUpdate=!0,t[i].isSbutton?(s.sBtnCount++,2===s.sBtnCount&&s.updateDoors(t[i].name,!0)):s.updateDoors(t[i].name,!0));else if(0===t[i].material.color.r)if(t[i].material.color=new THREE.Color("#BBBAA3"),t[i].material.needsUpdate=!0,t[i].isSbutton){if(2===s.sBtnCount){clearTimeout(s.timeout);var p=t[i].name;s.timeout=setTimeout(function(){s.updateDoors(p,!1)},15e3)}s.sBtnCount=Math.max(0,s.sBtnCount-1)}else s.updateDoors(t[i].name,!1)}},s.makePressureButton=function(t){var e=2.75,i=3,o=.1,n=t.translate.clone();if(t.invisible){var r={position:new THREE.Vector3(n.x,n.y+1.01*o/2,n.z),material:{color:new THREE.Color("#BBBAA3")}};return r.isSbutton=t.isSbutton||!1,r.name=t.id||"",s.buttonMeshes.push(r),!1}var a=new THREE.CylinderGeometry(e,i,o,60,1,(!1)),h=new THREE.MeshPhongMaterial({color:38144}),r=new THREE.Mesh(a,h);r.position.set(n.x,n.y,n.z),r.name=t.id||"",r.isSbutton=t.isSbutton||!1,r.collisionFilterMask=this.group(1)|this.group(2)|this.group(3),FPP.LCS.scene.add(r),t.translate.y+=1*o,s.physicsTile(t.translate,e,e),s.loader.load(t.path,function(t){var i=new THREE.MeshPhongMaterial({map:t,side:THREE.FrontSide}),a=1.8*e,h=new THREE.PlaneGeometry(a,a),l=new THREE.Mesh(h,i);l.position.set(n.x,n.y+1.01*o/2,n.z),l.rotation.x-=Math.PI/2,l.material.transparent=!0,FPP.LCS.scene.add(l),s.buttonMeshes.push(r)},function(t){console.log(t.loaded/t.total*100+"% loaded")},function(e){console.log(e,'Texture "'+t.path+'" Load Error Occurred')})},s.init=function(){s.groundMaterial=new CANNON.Material("groundMaterial"),s.ground_ground_cm=new CANNON.ContactMaterial(this.groundMaterial,this.groundMaterial,{friction:.4,restitution:.3,contactEquationStiffness:1e8,contactEquationRelaxation:3,frictionEquationStiffness:1e8,frictionEquationRegularizationTime:3}),s.world.quatNormalizeSkip=0,s.world.quatNormalizeFast=!1,s.world.gravity.set(0,-20,0),s.world.broadphase=new CANNON.NaiveBroadphase,s.world.addContactMaterial(s.ground_ground_cm)},s}(window,document),FPP.POINTERLOCK=function(t,e,i){var o=new function(){this.blocker=e.getElementById("blocker"),this.instructions=e.getElementById("instructions"),this.havePointerLock="pointerLockElement"in e||"mozPointerLockElement"in e||"webkitPointerLockElement"in e};return o.init=function(){if(o.havePointerLock){var t=e.body,i=function(i){e.pointerLockElement===t||e.mozPointerLockElement===t||e.webkitPointerLockElement===t?(FPP.PLAYER.controls.enabled=!0,o.blocker.style.display="none"):(FPP.PLAYER.controls.enabled=!1,o.blocker.style.display="-webkit-box",o.blocker.style.display="-moz-box",o.blocker.style.display="box",o.instructions.style.display="")},s=function(t){o.instructions.style.display=""};e.addEventListener("pointerlockchange",i,!1),e.addEventListener("mozpointerlockchange",i,!1),e.addEventListener("webkitpointerlockchange",i,!1),e.addEventListener("pointerlockerror",s,!1),e.addEventListener("mozpointerlockerror",s,!1),e.addEventListener("webkitpointerlockerror",s,!1),o.instructions.addEventListener("click",function(i){if(o.instructions.style.display="none",t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var s=function(i){e.fullscreenElement!==t&&e.mozFullscreenElement!==t&&e.mozFullScreenElement!==t||(e.removeEventListener("fullscreenchange",s),e.removeEventListener("mozfullscreenchange",s),t.requestPointerLock())};e.addEventListener("fullscreenchange",s,!1),e.addEventListener("mozfullscreenchange",s,!1),t.requestFullscreen=t.requestFullscreen||t.mozRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen,t.requestFullscreen()}else t.requestPointerLock()},!1)}else o.instructions.innerHTML="Your browser doesn't seem to support Pointer Lock API"},o}(window,document),FPP.ROOM8=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.fCwall={specs:{translate:new THREE.Vector3(0,0,7.5),rx:-Math.PI/2,ry:0,rz:0,width:15,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"f"}},this.walls.push(this.fCwall),this.a3={specs:{translate:new THREE.Vector3(0,(-7.5),0),rx:0,ry:0,rz:0,width:15,height:15,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"f"}},this.walls.push(this.a3),this.b3={specs:{translate:new THREE.Vector3(7.5,0,0),rx:0,ry:0,rz:Math.PI/2,width:15,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"f"}},this.walls.push(this.b3),this.c3={specs:{translate:new THREE.Vector3((-7.5),0,0),rx:0,ry:0,rz:-Math.PI/2,width:15,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"f"}},this.walls.push(this.c3),this.move=new THREE.Vector3(0,(-12.5),517.5)};return o}(window,document),FPP.ROOM1=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.floor={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:40,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.floor),this.bwall={specs:{translate:new THREE.Vector3(0,(-5.5),(-20)),rx:Math.PI/2,ry:Math.PI,rz:0,width:30,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:3,wrap_h:1}},this.walls.push(this.bwall),this.fLwall={specs:{translate:new THREE.Vector3((-10),(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fLwall),this.fRwall={specs:{translate:new THREE.Vector3(10,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fRwall),this.wleft={specs:{translate:new THREE.Vector3(15,(-5.5),0),rx:0,ry:0,rz:Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.wleft),this.wright={specs:{translate:new THREE.Vector3((-15),(-5.5),0),rx:0,ry:0,rz:-Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.wright),this.ceil={specs:{translate:new THREE.Vector3(0,(-1),0),rx:0,ry:0,rz:Math.PI,width:30,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20}},this.walls.push(this.ceil),this.door={specs:{id:1,translate:new THREE.Vector3(0,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.door),this.btn={specs:{id:1,translate:new THREE.Vector3(0,(-9.9),0),path:"../assets/images/btn1.png"}},this.btns.push(this.btn),this.move=new THREE.Vector3(0,0,0)};return o}(window,document),FPP.ROOM2=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.fLwall={specs:{translate:new THREE.Vector3((-10),(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fLwall),this.fRwall={specs:{translate:new THREE.Vector3(10,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fRwall),this.bLwall={specs:{translate:new THREE.Vector3((-10),(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bLwall),this.bCwall={specs:{translate:new THREE.Vector3(0,(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!1,stretch:!0,side:"d"}},this.walls.push(this.bCwall),this.bRwall={specs:{translate:new THREE.Vector3(10,(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bRwall),this.door={specs:{id:2,translate:new THREE.Vector3(0,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.door),this.a2={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:40,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.a2),this.b2={specs:{translate:new THREE.Vector3(15,(-5.5),0),rx:0,ry:0,rz:Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.b2),this.c2={specs:{translate:new THREE.Vector3((-15),(-5.5),0),rx:0,ry:0,rz:-Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.c2),this.d2={specs:{translate:new THREE.Vector3(0,(-1),0),rx:0,ry:0,rz:Math.PI,width:30,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.d2),this.btn2a={specs:{id:2,translate:new THREE.Vector3((-5),(-9.9),0),path:"../assets/images/btn2.png",isSbutton:!0}},this.btns.push(this.btn2a),this.btn2b={specs:{id:2,translate:new THREE.Vector3(5,(-9.9),0),path:"../assets/images/btn2.png",isSbutton:!0}},this.btns.push(this.btn2b),this.move=new THREE.Vector3(0,(-10),80)};return o}(window,document),FPP.ROOM3=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.fLwall={specs:{translate:new THREE.Vector3((-10),(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fLwall),this.fCwall={specs:{translate:new THREE.Vector3(0,2,29.99),rx:-Math.PI/2,ry:0,rz:0,width:10,height:6,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fCwall),this.fRwall={specs:{translate:new THREE.Vector3(10,(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fRwall),this.bLwall={specs:{translate:new THREE.Vector3((-10),(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bLwall),this.bCwall={specs:{translate:new THREE.Vector3(0,(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!1,stretch:!0,side:"d"}},this.walls.push(this.bCwall),this.bRwall={specs:{translate:new THREE.Vector3(10,(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bRwall),this.a3={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:60,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.a3),this.b3={specs:{translate:new THREE.Vector3(15,(-2.5),0),rx:0,ry:0,rz:Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.b3),this.c3={specs:{translate:new THREE.Vector3((-15),(-2.5),0),rx:0,ry:0,rz:-Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.c3),this.d3={specs:{translate:new THREE.Vector3(0,5,0),rx:0,ry:0,rz:Math.PI,width:30,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20}},this.walls.push(this.d3),this.cage1={specs:{translate:new THREE.Vector3(0,(-5.5),10),rx:Math.PI/2,ry:0,rz:0,width:30,height:9,image_path:"../assets/images/bh.png",mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.cage1),this.doori={specs:{id:"3a",translate:new THREE.Vector3(0,(-9.99),0),rx:0,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.doori),this.btn3i={specs:{id:"3a",translate:new THREE.Vector3(10,(-9.99),(-10)),path:"../assets/images/btn1.png",isSbutton:!1}},this.btns.push(this.btn3i),this.btn3ii={specs:{id:"3b",translate:new THREE.Vector3(0,(-9.99),(-10)),path:"../assets/images/btn1.png",isSbutton:!1}},this.btns.push(this.btn3ii),this.doorii={specs:{id:"3b",translate:new THREE.Vector3(0,(-5.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.doorii),this.move=new THREE.Vector3(0,(-5),150.2)};return o}(window,document),FPP.ROOM4=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.bLwall={specs:{translate:new THREE.Vector3((-3.5),(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:3,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bLwall),this.bRwall={specs:{translate:new THREE.Vector3(3.5,(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:3,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bRwall),this.a2={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:4.5,height:40,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.a2),this.b2={specs:{translate:new THREE.Vector3(2.2,(-5.5),0),rx:0,ry:0,rz:Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.b2),this.c2={specs:{translate:new THREE.Vector3((-2.2),(-5.5),0),rx:0,ry:0,rz:-Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.c2),this.d2={specs:{translate:new THREE.Vector3(0,(-1),0),rx:0,ry:0,rz:Math.PI,width:4.5,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.d2),this.door1={specs:{id:"4a",translate:new THREE.Vector3(0,(-12),0),rx:Math.PI/2,ry:0,rz:0,width:4.5,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.door1),this.btn1={specs:{id:"4a",translate:new THREE.Vector3(0,(-9.99),(-4)),path:"../assets/images/btn1-2.png",isSbutton:!1}},this.btns.push(this.btn1),this.btn2a={specs:{id:"4b",translate:new THREE.Vector3(0,(-9.99),13),path:"../assets/images/btn2.png",isSbutton:!0}},this.btns.push(this.btn2a),this.btn2b={specs:{id:"4b",translate:new THREE.Vector3(0,(-9.99),(-4)),path:"../assets/images/btn2.png",isSbutton:!0,invisible:!0}},this.btns.push(this.btn2b),this.door2={specs:{id:"4b",translate:new THREE.Vector3(0,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:4.5,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.door2),this.move=new THREE.Vector3(0,(-5),220.2)};return o}(window,document),FPP.ROOM5=function(t,e,i){var o=new function(){this.walls=[],this.btns=[];var t={specs:{translate:new THREE.Vector3((-10),(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(t),t={specs:{translate:new THREE.Vector3((-10),(-2.5),10),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(t),t={specs:{translate:new THREE.Vector3((-10),(-2.5),(-10)),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(t);var e={specs:{translate:new THREE.Vector3(10,(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(e),e={specs:{translate:new THREE.Vector3(10,(-2.5),10),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(e),e={specs:{translate:new THREE.Vector3(10,(-2.5),(-10)),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(e);var i={specs:{translate:new THREE.Vector3(0,2,29.99),rx:-Math.PI/2,ry:0,rz:0,width:10,height:6,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(i);var o={specs:{translate:new THREE.Vector3((-10),(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(o);var s={specs:{translate:new THREE.Vector3(10,(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(s);var n={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:60,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}};this.walls.push(n);var r={specs:{translate:new THREE.Vector3(15,(-2.5),0),rx:0,ry:0,rz:Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}};this.walls.push(r);var a={specs:{translate:new THREE.Vector3((-15),(-2.5),0),rx:0,ry:0,rz:-Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}};this.walls.push(a);var h={specs:{translate:new THREE.Vector3(0,5,0),rx:0,ry:0,rz:Math.PI,width:30,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20}};this.walls.push(h);var l={specs:{translate:new THREE.Vector3(10,(-5.5),(-.5)),rx:Math.PI/4,ry:0,rz:0,width:10,height:9*Math.sqrt(2),image_path:"../assets/images/floor3.jpg"},options:{solid:!0,stretch:!0,side:"f"}};this.walls.push(l);var p={specs:{translate:new THREE.Vector3(5,(-1),(-7.5)),rx:0,ry:0,rz:0,width:20,height:5,image_path:"../assets/images/floor3.jpg"},options:{solid:!0,stretch:!1,wrap_w:6,wrap_h:1,side:"f"}};this.walls.push(p);var c={specs:{translate:new THREE.Vector3((-10),(-5.5),19.5),rx:Math.PI/4,ry:0,rz:0,width:10,height:9*Math.sqrt(2),image_path:"../assets/images/floor3.jpg"},options:{solid:!0,stretch:!0,side:"f"}};this.walls.push(c);var u={specs:{translate:new THREE.Vector3((-5),(-1),12.5),rx:0,ry:0,rz:0,width:20,height:5,image_path:"../assets/images/floor3.jpg"},options:{solid:!0,stretch:!1,wrap_w:6,wrap_h:1,side:"f"}};this.walls.push(u);var d={specs:{id:"5a",translate:new THREE.Vector3(0,(-5.5),(-10)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(d);var v={specs:{id:"5b",translate:new THREE.Vector3(0,(-5.5),10),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(v);var f={specs:{id:"5c",translate:new THREE.Vector3(0,(-5.5),30),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(f);var m={specs:{id:"5a",translate:new THREE.Vector3(0,(-9.99),(-18)),path:"../assets/images/btn1.png",isSbutton:!1}};this.btns.push(m);var y={specs:{id:"5b",translate:new THREE.Vector3(10,(-9.99),(-18)),path:"../assets/images/btn1.png",isSbutton:!1}};this.btns.push(y);var w={specs:{id:"5c",translate:new THREE.Vector3((-10),(-9.99),(-18)),path:"../assets/images/btn1.png",isSbutton:!1}};this.btns.push(w),this.move=new THREE.Vector3(0,(-5),330.2)};return o}(window,document),FPP.ROOM6=function(t,e,i){var o=new function(){this.walls=[],this.btns=[];var t={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:40,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}};this.walls.push(t);var e={specs:{translate:new THREE.Vector3((-10),(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(e);var i={specs:{translate:new THREE.Vector3(0,(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!1,stretch:!0,side:"d"}};this.walls.push(i);var o={specs:{translate:new THREE.Vector3(9,(-5.5),(-15)),rx:0,ry:Math.PI/2,rz:Math.PI/2,width:10,height:9,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(o);var s={specs:{translate:new THREE.Vector3((-9),(-5.5),(-15)),rx:0,ry:Math.PI/2,rz:Math.PI/2,width:10,height:9,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(s);var n={specs:{translate:new THREE.Vector3(10,(-5.5),(-20)),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(n);var r={specs:{translate:new THREE.Vector3((-10),(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(r);var a={specs:{translate:new THREE.Vector3(10,(-5.5),20),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(a);var h={specs:{translate:new THREE.Vector3(15,(-5.5),0),rx:0,ry:0,rz:Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}};this.walls.push(h);var l={specs:{translate:new THREE.Vector3((-15),(-5.5),0),rx:0,ry:0,rz:-Math.PI/2,width:9,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}};this.walls.push(l);var p={specs:{translate:new THREE.Vector3(0,(-1),0),rx:0,ry:0,rz:Math.PI,width:30,height:40,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20}};this.walls.push(p);var c={specs:{id:"7b",translate:new THREE.Vector3(0,(-5.5),20),
rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(c);var c={specs:{id:"7a",translate:new THREE.Vector3((-10),(-5.5),0),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(c);var u={specs:{translate:new THREE.Vector3(0,(-5.5),0),rx:Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(u);var c={specs:{id:"7c",translate:new THREE.Vector3(10,(-5.5),0),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(c);var d={specs:{id:"7a",translate:new THREE.Vector3((-12),(-9.9),(-17)),path:"../assets/images/btn1.png",isSbutton:!1}};this.btns.push(d);var d={specs:{id:"7b",translate:new THREE.Vector3(12,(-9.9),(-17)),path:"../assets/images/btn1.png",isSbutton:!1}};this.btns.push(d);var d={specs:{id:"7c",translate:new THREE.Vector3(10,(-9.9),5),path:"../assets/images/btn2.png",isSbutton:!0}};this.btns.push(d);var d={specs:{id:"7c",translate:new THREE.Vector3((-10),(-9.9),5),path:"../assets/images/btn2.png",isSbutton:!0}};this.btns.push(d),this.move=new THREE.Vector3(0,(-5),390.2)};return o}(window,document),FPP.ROOM7=function(t,e,i){var o=new function(){this.walls=[],this.btns=[],this.fLwall={specs:{translate:new THREE.Vector3((-10),(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fLwall),this.fCwall={specs:{translate:new THREE.Vector3(0,2,29.99),rx:-Math.PI/2,ry:0,rz:0,width:10,height:6,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fCwall),this.fRwall={specs:{translate:new THREE.Vector3(10,(-2.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.fRwall),this.bLwall={specs:{translate:new THREE.Vector3((-10),(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bLwall),this.bCwall={specs:{translate:new THREE.Vector3(0,(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!1,stretch:!0,side:"d"}},this.walls.push(this.bCwall),this.bRwall={specs:{translate:new THREE.Vector3(10,(-2.5),(-30)),rx:Math.PI/2,ry:0,rz:0,width:10,height:15,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.bRwall),this.a3={specs:{translate:new THREE.Vector3(0,(-10),0),rx:0,ry:0,rz:0,width:30,height:60,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,stretch:!1,wrap_w:15,wrap_h:20,side:"d"}},this.walls.push(this.a3),this.b3={specs:{translate:new THREE.Vector3(15,(-2.5),0),rx:0,ry:0,rz:Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.b3),this.c3={specs:{translate:new THREE.Vector3((-15),(-2.5),0),rx:0,ry:0,rz:-Math.PI/2,width:15,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!0,stretch:!1,wrap_w:2,wrap_h:10}},this.walls.push(this.c3),this.d3={specs:{translate:new THREE.Vector3(0,5,0),rx:0,ry:0,rz:Math.PI,width:30,height:60,image_path:"../assets/images/floor4.jpg"},options:{solid:!1,stretch:!1,wrap_w:15,wrap_h:20}},this.walls.push(this.d3),this.cage1={specs:{translate:new THREE.Vector3(0,(-5.5),10),rx:Math.PI/2,ry:0,rz:0,width:6,height:9,image_path:"../assets/images/bh.png",mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.cage1),this.cage2={specs:{translate:new THREE.Vector3(0,(-5.5),16),rx:Math.PI/2,ry:0,rz:0,width:6,height:9,image_path:"../assets/images/bh.png",mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.cage2),this.cage3={specs:{translate:new THREE.Vector3(3,(-5.5),13),rx:Math.PI/2,ry:0,rz:Math.PI/2,width:6,height:9,image_path:"../assets/images/bh.png",mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.cage3),this.cage4={specs:{translate:new THREE.Vector3((-3),(-5.5),13),rx:Math.PI/2,ry:0,rz:Math.PI/2,width:6,height:9,image_path:"../assets/images/bh.png",mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.1,side:THREE.DoubleSide})},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.cage4),this.doori={specs:{id:"6a",translate:new THREE.Vector3(0,(-9.99),0),rx:0,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.doori),this.btni={specs:{id:"6a",translate:new THREE.Vector3(0,(-9.99),(-10)),path:"../assets/images/btn1.png",isSbutton:!1}},this.btns.push(this.btni),this.btnii={specs:{id:"6b",translate:new THREE.Vector3(0,(-9.99),13),path:"../assets/images/btn1.png",isSbutton:!1}},this.btns.push(this.btnii),this.doorii={specs:{id:"6b",translate:new THREE.Vector3(0,(-5.5),30),rx:-Math.PI/2,ry:0,rz:0,width:10,height:9,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}},this.walls.push(this.doorii),this.move=new THREE.Vector3(0,(-10),480)};return o}(window,document),FPP.BUILDSCENE=function(t,e,i){var o=new function(){this.walls=[],this.btns=[];var t={specs:{translate:new THREE.Vector3(0,(-20),430),rx:0,ry:Math.PI/2,rz:0,width:40,height:10,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:0,side:THREE.DoubleSide})},options:{solid:!0,side:"d"}};this.walls.push(t),t={specs:{translate:new THREE.Vector3(0,(-15),362.7),rx:0,ry:Math.PI/2,rz:0,width:5,height:10,image_path:"../assets/images/floor1.jpg"},options:{solid:!0,side:"d"}},this.walls.push(t),t={specs:{translate:new THREE.Vector3(0,(-15),270.2),rx:0,ry:Math.PI/2,rz:0*Math.PI/4,width:60,height:3,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.05,side:THREE.DoubleSide})},options:{solid:!0,side:"d"}},this.walls.push(t);var e={specs:{id:"bridge3-4",translate:new THREE.Vector3(0,(-11.99),290),rx:Math.PI/2,ry:0,rz:0,width:10,height:6,image_path:"../assets/images/door.jpg"},options:{solid:!0,stretch:!0,side:"d"}};this.walls.push(e);var i={specs:{id:"bridge3-4",translate:new THREE.Vector3(0,(-40),270),path:"../assets/images/btn2.png",isSbutton:!0}};this.btns.push(i);var o={specs:{id:"bridge3-4",translate:new THREE.Vector3(0,(-14.99),270),path:"../assets/images/btn2.png",isSbutton:!0}};this.btns.push(o),t={specs:{translate:new THREE.Vector3(0,(-15),190.2),rx:0,ry:Math.PI/2,rz:0,width:20,height:10,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.2,side:THREE.DoubleSide})},options:{solid:!0,side:"d"}},this.walls.push(t),t={specs:{translate:new THREE.Vector3(0,(-17.5),110),rx:-.2449786631,ry:Math.PI/2,rz:0,width:21,height:10,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.3,side:THREE.DoubleSide})},options:{solid:!0,side:"d"}},this.walls.push(t),t={specs:{translate:new THREE.Vector3(0,(-15),40),rx:.24497866312686414,ry:Math.PI/2,rz:0,width:41.5,height:10,mat:new THREE.MeshPhongMaterial({transparent:!0,opacity:.4,side:THREE.DoubleSide})},options:{solid:!0,side:"d"}},this.walls.push(t)};return o.build=function(){FPP.GEOMETRY.world.gravity.set(0,-20,0);var t=function(t){FPP.GEOMETRY.makeTile(t.specs,t.options)},e=function(t){FPP.GEOMETRY.makePressureButton(t.specs)};for(var i in o.walls)t(o.walls[i]);for(var s in o.btns)e(o.btns[s]);for(var n=8,r=1;r<=n;r++){var a="ROOM"+r,h=FPP[a].walls,l=FPP[a].btns;for(var i in h)h[i].specs.translate.add(FPP[a].move),t(h[i]);for(var s in l)l[s].specs.translate.add(FPP[a].move),e(l[s])}FPP.LCS.scene.fog=new THREE.Fog(6840435,1,1415);for(var r=0;r<=6;r++){var p={specs:{translate:new THREE.Vector3(0,5,0),rx:-Math.PI/2,ry:0,rz:0,width:2,height:4},options:{solid:!1,stretch:!0,side:"d"}};p.specs.gifId=String(r),p.specs.image_path="../assets/images/test/0"+r+".png",FPP.GEOMETRY.makeTile(p.specs,p.options)}},o}(window,document),FPP.SKYBOX=function(t,e,i){var o=new function(){this.cubeLoader=new THREE.CubeTextureLoader},s=function(){var t="../assets/images/skybox/earth.png";FPP.GEOMETRY.loader.load(t,function(t){var e=new THREE.SphereGeometry(25,32,32);material=new THREE.MeshPhongMaterial({map:t,side:THREE.DoubleSide}),o.earth=new THREE.Mesh(e,material),o.earth.castShadow=!1,o.earth.receiveShadow=!1,o.earth.position.set(0,500,500),o.earth.rotation.copy(new THREE.Euler((-1.0415075972387453),.039375342576198576,3.1267351616991386,"XYZ")),FPP.LCS.scene.add(o.earth)})},n=function(){var t=new THREE.ConeGeometry(10.5,500,4,15,(!1)),e=new THREE.MeshBasicMaterial({transparent:!0,opacity:.5,side:THREE.DoubleSide});o.elevator=new THREE.Mesh(t,e),o.elevator.position.set(0,230.1,517.5),o.elevator.rotation.y=Math.PI/4,o.elevator.updated=!1,FPP.LCS.scene.add(o.elevator),o.edges=new THREE.WireframeHelper(o.elevator,16777215),FPP.LCS.scene.add(o.edges)};return o.makeBox=function(){s(),n(),o.cubeLoader.setPath("../assets/images/skybox/sky1/");var t=o.cubeLoader.load(["map_04.jpg","map_06.jpg","map_08.jpg","map_02.jpg","map_05.jpg","map_10.jpg"]),e=new THREE.BoxGeometry(1e3,1e3,1e3),i=new THREE.MeshBasicMaterial({envMap:t,side:THREE.BackSide});o.space=new THREE.Mesh(e,i),FPP.LCS.scene.add(o.space)},o.update=function(){if(o.space&&o.space.position.copy(FPP.PLAYER.firstPerson.position),o.earth&&(o.earth.position.y=500+FPP.PLAYER.firstPerson.position.y,o.elevator&&!o.elevator.updated&&(o.elevator.geometry.vertices[0].y=o.earth.position.y,o.elevator.geometry.verticesNeedUpdate=!0,o.elevator.updated=!0)),FPP.PLAYER.firstPerson.position.z>=512){FPP.SKYBOX.elevator.material.opacity+=.001;t.setTimeout(function(){e.getElementById("endgame").style.display="flex"},9500)}},o.init=function(){o.makeBox()},o}(window,document),FPP.PLAYER=function(t,e,i){var o=location.search.slice(1),s=o.search(/level=[1-9]/)>-1?o.match(/[1-9]/)[0]:1,n={1:function(){return new THREE.Vector3(0,(-5),(-10))},2:function(){return new THREE.Vector3(0,(-10),70)},3:function(){return new THREE.Vector3(0,(-10),140)},4:function(){return new THREE.Vector3(0,(-10),210)},5:function(){return new THREE.Vector3(0,(-10),280)},6:function(){return new THREE.Vector3(0,(-10),308)},7:function(){return new THREE.Vector3(0,(-10),382)},8:function(){return new THREE.Vector3(0,0,465)},9:function(){return new THREE.Vector3(0,0,520)}},r=new function(){var t=5,i=2,o=new CANNON.Sphere(i),r=FPP.GEOMETRY.group;this.firstPerson=new CANNON.Body({mass:t,material:FPP.GEOMETRY.groundMaterial}),this.firstPerson.addShape(o),this.firstPerson.position.copy(n[s]()),this.firstPerson.linearDamping=.9,this.firstPerson.collisionFilterGroup=r(2),this.firstPerson.posLog=[],this.firstPerson.rewinding=!1,this.p2=new CANNON.Body({mass:t,material:FPP.GEOMETRY.groundMaterial}),this.p2.startPos=new CANNON.Vec3(0,0,0),this.p2.addShape(o),this.p2.position.y=-10,this.p2.collisionFilterGroup=r(3),this.p2.timeLog=[],this.p2.playback=!1,this.p2.recording=!1,this.rewindSpeed=2,this.timer=0,this.time=0,this.dt=1/60,this.clock=e.getElementById("clock"),this.frame=0,this.frameDelayCounter=0,this.gifDir=!1,this.frameDelay=4;new THREE.IcosahedronGeometry(i);material=new THREE.MeshPhongMaterial({color:16777215,transparent:!0,opacity:.4,side:THREE.FrontSide})};return r.formatTime=function(t){var e=r.time*r.dt,i=~~e%60+":"+~~(10*e%10),o=t?"green":"red";if(r.timer){var s=r.timer*r.dt;r.clock.innerHTML=i+" <span style='color:"+o+"'>"+~~s%60+":"+~~(10*s%10)+"</span>"}else r.clock.innerHTML=i},r.p2.startRecord=function(){r.time=0,r.p2.recording=!0,r.p2.playback=!1,r.p2.startPos.copy(r.firstPerson.position),e.getElementById("rewind").style.display="block"},r.p2.startPlayback=function(){r.frameDelayCounter=0,r.timer=r.time,r.p2.recording=!1,r.p2.playback=!0,r.p2.timeLog.reverse(),r.firstPerson.rewinding=!0,e.getElementById("clock").classList.toggle("clock-rewind"),e.getElementById("rewind").style.display="none"},e.addEventListener("click",function(t){r.controls.enabled&&!r.firstPerson.rewinding&&(r.p2.recording?r.p2.startPlayback():r.p2.playback||r.p2.startRecord())}),r.p2.record=function(t,e,i){r.placeholder||(r.placeholder=FPP.GEOMETRY.gifs[0]),r.p2.recording&&r.controls.enabled&&(r.time++,r.formatTime(),r.p2.timeLog.push(t,e,i),r.time%r.rewindSpeed===0&&r.firstPerson.posLog.push(r.firstPerson.position.clone()))},r.rewind=function(){r.firstPerson.posLog.length?(r.firstPerson.position.copy(r.firstPerson.posLog.pop()),r.time-=r.rewindSpeed,r.formatTime()):(r.firstPerson.rewinding=!1,r.time=0,r.firstPerson.position.copy(r.p2.startPos),r.p2.position.copy(r.p2.startPos),r.placeholder.position.copy(r.p2.startPos),e.getElementById("clock").classList.toggle("clock-rewind"))},r.p2.update=function(){if(r.firstPerson.position.y<-100)r.firstPerson.position.copy(n[1]());else if(r.firstPerson.rewinding)r.rewind();else if(r.p2.playback){r.time++;var t=7;r.frameDelayCounter++%r.frameDelay===0&&(r.frame=(r.frame+1)%t);for(var e=FPP.GEOMETRY.gifs,i=0;i<t;i++)e[i].visible=!1;var o=e[r.frame];if(o.visible=!0,o.visible=!0,r.placeholder=o,o.lookAt(r.firstPerson.position),Math.random()<.01&&(r.gifDir=!r.gifDir),r.gifDir&&r.placeholder.rotateY(Math.PI),r.p2.timeLog.length){r.formatTime(),r.p2.velocity.x=r.p2.timeLog.pop();var s=r.p2.timeLog.pop();s>1&&(r.p2.velocity.y=s),r.p2.velocity.z=r.p2.timeLog.pop(),r.placeholder.position.copy(r.p2.position)}else o.visible=!1,r.p2.position.y-=100,r.p2.playback=!1,r.p2.recording=!1,r.formatTime(!0),r.time=0,r.timer=0}},e.addEventListener("keydown",function(t){t.keyCode>=49&&t.keyCode<=56&&FPP.PLAYER.firstPerson.position.copy(n[t.keyCode-48]())}),r.init=function(){FPP.GEOMETRY.world.addBody(r.firstPerson),FPP.GEOMETRY.world.addBody(r.p2),r.controls=new PointerLockControls(FPP.LCS.camera,r.firstPerson,r.p2),FPP.LCS.scene.add(r.controls.getObject())},r}(window,document),FPP.ANIMATE=function(t,e,i){var o=new function(){this.dt=1/60,this.frame=0,this.time=Date.now()};return t.requestAnimFrame=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(e,i){t.setTimeout(e,1e3/60)}}(),o.animate=function(){requestAnimFrame(o.animate),FPP.PLAYER.controls.enabled&&(FPP.GEOMETRY.world.step(o.dt),FPP.PLAYER.p2.update()),FPP.GEOMETRY.updateButtons(),FPP.SKYBOX.update(),FPP.PLAYER.controls.update(Date.now()-o.time),FPP.LCS.renderer.render(FPP.LCS.scene,FPP.LCS.camera),o.time=Date.now()},o.start=function(){o.animate()},o}(window,document),document.addEventListener("DOMContentLoaded",function(t){FPP.LCS.init(),FPP.POINTERLOCK.init(),FPP.GEOMETRY.init(),FPP.BUILDSCENE.build(),FPP.SKYBOX.init(),FPP.PLAYER.init(),FPP.ANIMATE.start()});